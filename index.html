<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseDx ‚Äì Medical Case Simulator</title>
    <!-- PDF.js text layer CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #dbeafe;
            --success: #16a34a; --success-light: #dcfce7;
            --warning: #d97706; --warning-light: #fef3c7;
            --danger: #dc2626; --danger-light: #fee2e2;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
            --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
            --radius: 8px; --radius-lg: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; overflow: hidden; height: 100vh; }
        .app-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-md); z-index: 100; height: 52px; }
        .app-header h1 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border: none; border-radius: var(--radius); font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .btn-primary { background: white; color: var(--primary); }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-outline { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        .btn-ghost { background: transparent; color: var(--gray-500); padding: 5px 8px; }
        .btn-ghost:hover { background: var(--gray-100); color: var(--gray-700); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-icon { padding: 6px; min-width: 32px; justify-content: center; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .main-container { display: flex; height: calc(100vh - 52px); overflow: hidden; }
        .pdf-panel { flex: 1; display: flex; flex-direction: column; background: var(--gray-200); min-width: 300px; }
        .pdf-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--gray-800); color: white; font-size: 0.85rem; }
        .pdf-toolbar-group { display: flex; align-items: center; gap: 6px; }
        .pdf-toolbar .btn { color: white; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; font-size: 0.8rem; }
        .pdf-toolbar .btn:hover { background: rgba(255,255,255,0.2); }
        .pdf-content { flex: 1; overflow: auto; display: flex; align-items: flex-start; justify-content: center; }
        .pdf-canvas-container { display: flex; flex-direction: column; align-items: center; padding: 10px; gap: 10px; }

        /* PDF page wrapper for text selection */
        .pdf-page-wrapper {
            position: relative;
            box-shadow: var(--shadow-lg);
            margin-bottom: 10px;
        }
        .pdf-page-wrapper canvas {
            display: block;
        }
        /* Text layer for selection */
        .pdf-page-wrapper .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.25;
            line-height: 1.0;
        }
        .pdf-page-wrapper .textLayer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
        }
        .pdf-page-wrapper .textLayer ::selection {
            background: rgba(37, 99, 235, 0.4);
        }
        .pdf-page-wrapper .textLayer .highlight {
            margin: -1px;
            padding: 1px;
            background-color: rgba(255, 255, 0, 0.4);
            border-radius: 4px;
        }

        .pdf-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: var(--gray-400); text-align: center; padding: 40px; }
        .pdf-placeholder .upload-icon { font-size: 4rem; }
        .pdf-placeholder h3 { color: var(--gray-600); }
        .drop-zone-active .pdf-content { background: var(--primary-light); border: 3px dashed var(--primary); }
        .resize-handle { width: 6px; background: var(--gray-300); cursor: col-resize; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .resize-handle:hover, .resize-handle.active { background: var(--primary); }
        .resize-handle::after { content: '‚ãÆ'; color: var(--gray-500); font-size: 1.2rem; }
        .resize-handle:hover::after { color: white; }
        .workspace-panel { width: 520px; min-width: 380px; max-width: 800px; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .workspace-tabs { display: flex; background: var(--gray-50); border-bottom: 2px solid var(--gray-200); overflow-x: auto; flex-shrink: 0; }
        .workspace-tab { padding: 10px 16px; font-size: 0.82rem; font-weight: 600; color: var(--gray-500); cursor: pointer; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; background: none; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: all 0.2s; }
        .workspace-tab:hover { color: var(--gray-700); background: var(--gray-100); }
        .workspace-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .workspace-tab .badge { background: var(--gray-200); color: var(--gray-600); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; font-weight: 700; }
        .workspace-tab.active .badge { background: var(--primary-light); color: var(--primary); }
        .workspace-content { flex: 1; overflow-y: auto; padding: 16px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .section-card { background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 16px; overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); cursor: pointer; user-select: none; }
        .section-header h3 { font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-header .collapse-icon { transition: transform 0.2s; font-size: 0.75rem; color: var(--gray-400); }
        .section-header.collapsed .collapse-icon { transform: rotate(-90deg); }
        .section-body { padding: 12px 14px; }
        .section-body.collapsed { display: none; }
        .input-group { display: flex; gap: 6px; margin-bottom: 10px; }
        .input-group input { flex: 1; padding: 8px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; }
        .input-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .dx-list { list-style: none; }
        .dx-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; margin-bottom: 4px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); cursor: grab; user-select: none; }
        .dx-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .dx-item.drag-over { border-top: 2px solid var(--primary); }
        .dx-rank { font-weight: 800; color: var(--primary); font-size: 0.85rem; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--primary-light); border-radius: 50%; flex-shrink: 0; }
        .dx-rank.top { background: var(--success-light); color: var(--success); }
        .dx-drag-handle { color: var(--gray-400); cursor: grab; font-size: 1rem; flex-shrink: 0; }
        .dx-text { flex: 1; font-size: 0.87rem; font-weight: 500; }
        .dx-actions { display: flex; gap: 2px; flex-shrink: 0; }
        .dx-actions .btn-icon { font-size: 0.85rem; padding: 3px; min-width: 24px; }
        .dx-ruled-out { text-decoration: line-through; opacity: 0.5; }
        .dx-ruled-out .dx-rank { background: var(--danger-light); color: var(--danger); }
        .item-list { list-style: none; }
        .item-entry { display: flex; align-items: flex-start; gap: 8px; padding: 8px 10px; margin-bottom: 4px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); }
        .item-entry .item-icon { flex-shrink: 0; margin-top: 2px; }
        .item-entry .item-content { flex: 1; }
        .item-entry .item-name { font-size: 0.87rem; font-weight: 600; }
        .item-entry .item-rationale { font-size: 0.8rem; color: var(--gray-500); margin-top: 2px; }
        .item-entry .item-category { font-size: 0.7rem; padding: 1px 8px; border-radius: 10px; font-weight: 600; flex-shrink: 0; margin-top: 2px; }
        .cat-lab { background: #ede9fe; color: #7c3aed; }
        .cat-imaging { background: #e0f2fe; color: #0284c7; }
        .cat-procedure { background: #fce7f3; color: #db2777; }
        .cat-other { background: var(--gray-100); color: var(--gray-600); }
        .cat-medication { background: #dcfce7; color: #16a34a; }
        .cat-intervention { background: #fef3c7; color: #d97706; }
        .cat-consult { background: #e0e7ff; color: #4f46e5; }
        .notes-textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; resize: vertical; }
        .notes-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .score-card { background: linear-gradient(135deg, var(--gray-800), var(--gray-900)); color: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
        .score-card h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-400); margin-bottom: 12px; }
        .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .score-item { text-align: center; }
        .score-value { font-size: 1.8rem; font-weight: 800; }
        .score-value.good { color: #4ade80; }
        .score-value.okay { color: #facc15; }
        .score-value.poor { color: #f87171; }
        .score-label { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 12px; }
        .comparison-table th { text-align: left; padding: 8px 10px; background: var(--gray-50); border-bottom: 2px solid var(--gray-200); font-weight: 700; font-size: 0.8rem; }
        .comparison-table td { padding: 8px 10px; border-bottom: 1px solid var(--gray-100); vertical-align: top; }
        .match-yes { color: var(--success); font-weight: 700; }
        .match-no { color: var(--danger); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: var(--radius-lg); width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--gray-200); }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-body { padding: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--gray-200); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: var(--gray-700); }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .settings-group { margin-bottom: 20px; }
        .settings-group h4 { font-size: 0.85rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--gray-200); }
        .radio-group { display: flex; flex-direction: column; gap: 6px; }
        .radio-option { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border: 1.5px solid var(--gray-200); border-radius: var(--radius); cursor: pointer; }
        .radio-option:hover { border-color: var(--primary); background: var(--primary-light); }
        .radio-option input[type="radio"] { accent-color: var(--primary); }
        .radio-option .option-label { font-weight: 600; font-size: 0.87rem; }
        .radio-option .option-desc { font-size: 0.78rem; color: var(--gray-500); }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 18px; border-radius: var(--radius); color: white; font-size: 0.87rem; font-weight: 500; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; max-width: 450px; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }
        .toast-warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 30px 20px; color: var(--gray-400); }
        .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .llm-status { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; }
        .llm-status:hover { background: rgba(255,255,255,0.2); }
        .llm-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-400); }
        .llm-dot.connected { background: #4ade80; }
        .llm-dot.needs-key { background: #facc15; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
        .phase-bar { display: flex; gap: 2px; margin-bottom: 12px; }
        .phase-step { flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; cursor: pointer; }
        .phase-step.active { background: var(--primary); }
        .phase-step.completed { background: var(--success); }
        .phase-labels { display: flex; justify-content: space-between; margin-bottom: 16px; }
        .phase-label { font-size: 0.7rem; color: var(--gray-400); cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .phase-label.active { color: var(--primary); font-weight: 700; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .answer-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .answer-tag.correct { background: var(--success-light); color: var(--success); }
        .answer-tag.incorrect { background: var(--danger-light); color: var(--danger); }
        .answer-tag.partial { background: var(--warning-light); color: var(--warning); }
        .workspace-content::-webkit-scrollbar, .pdf-content::-webkit-scrollbar { width: 8px; }
        .workspace-content::-webkit-scrollbar-thumb, .pdf-content::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 4px; }
        @media (max-width: 900px) { .main-container { flex-direction: column; } .pdf-panel { height: 40vh; min-width: unset; } .workspace-panel { width: 100% !important; min-width: unset; max-width: unset; } .resize-handle { width: 100%; height: 6px; cursor: row-resize; } }
        .key-input-wrapper { position: relative; }
        .key-input-wrapper input { padding-right: 40px; }
        .key-toggle { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--gray-400); }
        .helper-text { font-size: 0.78rem; color: var(--gray-400); margin-bottom: 8px; }
        .select-small { padding: 4px 8px; font-size: 0.8rem; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white; }
        .setup-banner { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: var(--gray-900); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 0.9rem; }
        .setup-banner .setup-text { flex: 1; }
        .setup-banner .setup-text strong { display: block; }
        .debug-log { background: var(--gray-900); color: #4ade80; border-radius: var(--radius); padding: 12px; font-family: 'Courier New', monospace; font-size: 0.75rem; max-height: 250px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; word-break: break-all; }
        .debug-log .log-error { color: #f87171; }
        .debug-log .log-info { color: #60a5fa; }
        .info-box { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 10px 12px; font-size: 0.78rem; color: var(--gray-500); margin-top: 8px; }
        .info-box a { color: var(--primary); font-weight: 600; }
        .info-box.warning { background: #fffbeb; border-color: #fbbf24; }
        .ak-card { border: 1.5px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 12px; overflow: hidden; }
        .ak-card-header { padding: 10px 14px; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .ak-card-body { padding: 10px 14px; }
        .ak-dx-card { border-color: var(--success); }
        .ak-dx-card .ak-card-header { background: var(--success-light); color: var(--success); }
        .ak-clinical-card { border-color: var(--warning); }
        .ak-clinical-card .ak-card-header { background: var(--warning-light); color: var(--warning); }
        .ak-dx-value { font-size: 1.05rem; font-weight: 700; color: var(--gray-800); padding: 4px 0; }
        .ak-list { list-style: none; padding: 0; }
        .ak-list li { padding: 6px 10px; margin: 3px 0; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .ak-diff-card { border-color: #8b5cf6; }
        .ak-diff-card .ak-card-header { background: #ede9fe; color: #7c3aed; }
        .ak-lab-card { border-color: #7c3aed; }
        .ak-lab-card .ak-card-header { background: #ede9fe; color: #7c3aed; }
        .ak-test-card { border-color: #0284c7; }
        .ak-test-card .ak-card-header { background: #e0f2fe; color: #0284c7; }
        .ak-tx-card { border-color: var(--success); }
        .ak-tx-card .ak-card-header { background: var(--success-light); color: var(--success); }
        .ak-empty { color: var(--gray-400); font-style: italic; font-size: 0.85rem; padding: 8px 0; }
        .dx-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .dx-compare-card { border-radius: var(--radius); padding: 14px; text-align: center; }
        .dx-compare-card.clinical { background: var(--warning-light); border: 1.5px solid var(--warning); }
        .dx-compare-card.final { background: var(--success-light); border: 1.5px solid var(--success); }
        .dx-compare-card .dx-type { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .dx-compare-card.clinical .dx-type { color: var(--warning); }
        .dx-compare-card.final .dx-type { color: var(--success); }
        .dx-compare-card .dx-value { font-size: 0.95rem; font-weight: 700; color: var(--gray-800); }
        .parsed-section { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 8px; }
        .parsed-section-header { font-size: 0.78rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .parsed-section-header .found { color: var(--success); }
        .parsed-section-header .missing { color: var(--danger); }
        .parsed-section-body { font-size: 0.82rem; color: var(--gray-600); max-height: 80px; overflow-y: auto; }
        .diff-dx-list { list-style: none; padding: 0; margin-top: 6px; }
        .diff-dx-item { padding: 4px 8px; margin: 2px 0; background: white; border: 1px solid var(--gray-200); border-radius: 4px; font-size: 0.82rem; font-weight: 500; }
    </style>
</head>
<body>
    <div class="setup-banner" id="setupBanner" style="display:none;"><div>üîë</div><div class="setup-text"><strong>API Key Required</strong><span>Enter your OpenRouter key.</span></div><button class="btn btn-sm" style="background:white;color:var(--gray-900);" onclick="openSettings()">Set Up ‚Üí</button><button class="btn btn-ghost btn-sm" style="color:var(--gray-700);" onclick="dismissBanner()">‚úï</button></div>
    <header class="app-header"><h1><span>ü©∫</span> CaseDx</h1><div class="header-actions"><div class="llm-status" onclick="openSettings()"><span class="llm-dot" id="llmDot"></span><span id="llmName">No LLM</span></div><label class="btn btn-primary" for="pdfInput" style="margin:0;cursor:pointer;">üìÑ Load PDF</label><input type="file" id="pdfInput" accept=".pdf" style="display:none;"><button class="btn btn-secondary" onclick="openSettings()">‚öô</button><button class="btn btn-secondary" onclick="resetCase()">üîÑ</button></div></header>
    <div class="main-container">
        <div class="pdf-panel" id="pdfPanel">
            <div class="pdf-toolbar" id="pdfToolbar" style="display:none;"><div class="pdf-toolbar-group"><button class="btn" onclick="prevPage()">‚óÄ</button><span><span id="pageNum">1</span>/<span id="pageCount">1</span></span><button class="btn" onclick="nextPage()">‚ñ∂</button></div><div class="pdf-toolbar-group"><button class="btn" onclick="zoomOut()">‚àí</button><span id="zoomLevel">100%</span><button class="btn" onclick="zoomIn()">+</button><button class="btn" onclick="extractCase()" id="extractBtn">ü§ñ Extract</button></div></div>
            <div class="pdf-content" id="pdfContent"><div class="pdf-placeholder" id="pdfPlaceholder"><div class="upload-icon">üìã</div><h3>Load a Case PDF</h3><p>Click "Load PDF" or drag & drop.</p><label class="btn btn-outline" for="pdfInput" style="cursor:pointer;">Choose File</label></div><div class="pdf-canvas-container" id="pdfCanvasContainer" style="display:none;"></div></div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="workspace-panel" id="workspacePanel">
            <div class="workspace-tabs">
                <button class="workspace-tab active" data-tab="workup">üîç Workup <span class="badge" id="workupCount">0</span></button>
                <button class="workspace-tab" data-tab="diagnoses">üéØ Dx <span class="badge" id="dxCount">0</span></button>
                <button class="workspace-tab" data-tab="testing">üß™ Tests <span class="badge" id="testCount">0</span></button>
                <button class="workspace-tab" data-tab="management">üíä Mgmt <span class="badge" id="mgmtCount">0</span></button>
                <button class="workspace-tab" data-tab="scoring">üìä Score</button>
            </div>
            <div class="workspace-content">
                <div class="tab-pane active" id="tab-workup">
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìã Case Phase</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><div class="phase-bar"><div class="phase-step active" onclick="setPhase(0)"></div><div class="phase-step" onclick="setPhase(1)"></div><div class="phase-step" onclick="setPhase(2)"></div><div class="phase-step" onclick="setPhase(3)"></div><div class="phase-step" onclick="setPhase(4)"></div></div><div class="phase-labels"><span class="phase-label active" onclick="setPhase(0)">HPI</span><span class="phase-label" onclick="setPhase(1)">Exam</span><span class="phase-label" onclick="setPhase(2)">Initial Dx</span><span class="phase-label" onclick="setPhase(3)">Results</span><span class="phase-label" onclick="setPhase(4)">Final Dx</span></div></div></div>
                    <div id="parsedSectionsPreview"></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üîë HPI</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="hpiNotes" placeholder="Key findings..."></textarea></div></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>ü©ª Exam</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="examNotes" placeholder="Findings..."></textarea></div></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìù Notes</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="generalNotes" placeholder="Thoughts..."></textarea></div></div>
                </div>
                <div class="tab-pane" id="tab-diagnoses"><div class="helper-text">Rank differentials. Drag to reorder.</div><div class="input-group"><input type="text" id="dxInput" placeholder="Enter a diagnosis..." onkeydown="if(event.key==='Enter')addDx()"><button class="btn btn-outline btn-sm" onclick="addDx()">+ Add</button></div><ul class="dx-list" id="dxList"></ul></div>
                <div class="tab-pane" id="tab-testing"><div class="helper-text">Order diagnostic tests.</div><div class="input-group" style="flex-wrap:wrap;"><input type="text" id="testInput" placeholder="e.g., CBC, CT chest..." onkeydown="if(event.key==='Enter')addTest()" style="flex:1;min-width:200px;"><select class="select-small" id="testCat"><option value="lab">üß™ Lab</option><option value="imaging">ü©ª Imaging</option><option value="procedure">üî¨ Procedure</option><option value="other">üìã Other</option></select><button class="btn btn-outline btn-sm" onclick="addTest()">+ Add</button></div><div style="margin-bottom:14px;"><input type="text" id="testRat" placeholder="Rationale (optional)" style="width:100%;padding:6px 12px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.83rem;"></div><ul class="item-list" id="testList"></ul></div>
                <div class="tab-pane" id="tab-management"><div class="helper-text">Treatments / interventions.</div><div class="input-group" style="flex-wrap:wrap;"><input type="text" id="mgmtInput" placeholder="e.g., IV NS 1L..." onkeydown="if(event.key==='Enter')addMgmt()" style="flex:1;min-width:200px;"><select class="select-small" id="mgmtCat"><option value="medication">üíä Medication</option><option value="intervention">üè• Intervention</option><option value="consult">üìû Consult</option><option value="other">üìã Other</option></select><button class="btn btn-outline btn-sm" onclick="addMgmt()">+ Add</button></div><div style="margin-bottom:14px;"><input type="text" id="mgmtRat" placeholder="Rationale (optional)" style="width:100%;padding:6px 12px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.83rem;"></div><ul class="item-list" id="mgmtList"></ul></div>
                <div class="tab-pane" id="tab-scoring"><div id="answerKeyDisplay"></div><div id="scoreResults" style="display:none;"></div></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal"><div class="modal"><div class="modal-header"><h2>‚öô Settings</h2><button class="btn btn-ghost" onclick="closeSettings()">‚úï</button></div><div class="modal-body">
        <div class="settings-group"><h4>LLM Provider</h4><div class="radio-group">
            <label class="radio-option"><input type="radio" name="llmProvider" value="none"><div><div class="option-label">None (Manual)</div></div></label>
            <label class="radio-option"><input type="radio" name="llmProvider" value="openrouter" checked><div><div class="option-label">OpenRouter ‚≠ê</div></div></label>
            <label class="radio-option"><input type="radio" name="llmProvider" value="gemini"><div><div class="option-label">Google Gemini</div></div></label>
            <label class="radio-option"><input type="radio" name="llmProvider" value="openai"><div><div class="option-label">OpenAI</div></div></label>
            <label class="radio-option"><input type="radio" name="llmProvider" value="ollama"><div><div class="option-label">Ollama (Local)</div></div></label>
        </div></div>
        <div class="settings-group" id="apiKeyGroup"><h4>API Key</h4><div class="form-group"><div class="key-input-wrapper"><input type="password" id="apiKeyInput" placeholder="Paste API key..."><button class="key-toggle" onclick="toggleKeyVis()">üëÅ</button></div><div id="apiKeyHelp" style="font-size:0.78rem;color:var(--primary);margin-top:4px;"></div></div></div>
        <div class="settings-group" id="ollamaGroup" style="display:none;"><h4>Ollama</h4><div class="form-group"><label>URL</label><input type="text" id="ollamaUrl" value="http://localhost:11434"></div><div class="form-group"><label>Model</label><input type="text" id="ollamaModel" value="llama3.2"></div></div>
        <div class="settings-group" id="openrouterGroup"><h4>OpenRouter</h4><div class="form-group"><input type="text" id="orModelInput" placeholder="meta-llama/llama-3.1-8b-instruct" style="width:100%;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;"><div class="info-box warning" style="margin-top:6px;">‚ö†Ô∏è Free models need: <a href="https://openrouter.ai/settings/privacy" target="_blank">privacy settings</a> ‚Üí Allow training</div></div></div>
        <div class="settings-group"><h4>Test</h4><button class="btn btn-warning btn-sm" onclick="testConn()" id="testBtn" style="width:100%;margin-bottom:8px;">üîå Test</button><div class="debug-log" id="debugLog">Ready.\n</div></div>
    </div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeSettings()">Cancel</button><button class="btn btn-success" onclick="saveSettings()">üíæ Save</button></div></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
    const S={pdfDoc:null,pg:1,zoom:1,pdfText:'',parsed:null,dx:[],tests:[],mgmt:[],phase:0,answer:null,llm:'openrouter',key:'',ollamaUrl:'http://localhost:11434',ollamaModel:'llama3.2',orModel:'meta-llama/llama-3.1-8b-instruct',nid:1};
    function dlog(m,t='info'){const e=document.getElementById('debugLog');if(e){e.innerHTML+=`<span class="log-${t}">[${new Date().toLocaleTimeString()}] ${m}</span>\n`;e.scrollTop=e.scrollHeight;}}

    document.addEventListener('DOMContentLoaded',()=>{
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        loadSettings();setupTabs();setupDD();setupResize();updateStatus();
        if(!S.key&&S.llm!=='none'&&S.llm!=='ollama')document.getElementById('setupBanner').style.display='flex';
        renderDxList();renderTestList();renderMgmtList();renderAK();
    });
    function dismissBanner(){document.getElementById('setupBanner').style.display='none';}

    // ===== PDF WITH TEXT LAYER =====
    document.getElementById('pdfInput').addEventListener('change',async e=>{if(e.target.files[0])await loadPDF(e.target.files[0]);});
    async function loadPDF(f){
        try{
            const b=await f.arrayBuffer();
            S.pdfDoc=await pdfjsLib.getDocument(new Uint8Array(b)).promise;
            document.getElementById('pdfToolbar').style.display='flex';
            document.getElementById('pdfPlaceholder').style.display='none';
            document.getElementById('pdfCanvasContainer').style.display='flex';
            document.getElementById('pageCount').textContent=S.pdfDoc.numPages;
            S.pdfText='';
            for(let i=1;i<=S.pdfDoc.numPages;i++){const p=await S.pdfDoc.getPage(i);const c=await p.getTextContent();S.pdfText+=c.items.map(x=>x.str).join(' ')+'\n\n';}
            S.pg=1;renderPg(1);
            S.parsed=parseSections(S.pdfText);renderParsedPreview();
            toast(`PDF loaded ‚Äî ${S.pdfDoc.numPages} pages`,'success');
        }catch(e){toast('PDF error: '+e.message,'error');}
    }

    async function renderPg(n){
        if(!S.pdfDoc)return;
        const page=await S.pdfDoc.getPage(n);
        const scale=S.zoom*1.5;
        const viewport=page.getViewport({scale});
        const container=document.getElementById('pdfCanvasContainer');
        container.innerHTML='';

        // Create wrapper div
        const wrapper=document.createElement('div');
        wrapper.className='pdf-page-wrapper';
        wrapper.style.width=viewport.width+'px';
        wrapper.style.height=viewport.height+'px';

        // Canvas
        const canvas=document.createElement('canvas');
        canvas.width=viewport.width;
        canvas.height=viewport.height;
        const ctx=canvas.getContext('2d');
        await page.render({canvasContext:ctx,viewport}).promise;
        wrapper.appendChild(canvas);

        // Text layer for selection
        const textContent=await page.getTextContent();
        const textLayerDiv=document.createElement('div');
        textLayerDiv.className='textLayer';
        textLayerDiv.style.width=viewport.width+'px';
        textLayerDiv.style.height=viewport.height+'px';
        wrapper.appendChild(textLayerDiv);

        // Render text spans
        pdfjsLib.renderTextLayer({
            textContent:textContent,
            container:textLayerDiv,
            viewport:viewport,
            textDivs:[]
        });

        container.appendChild(wrapper);
        document.getElementById('pageNum').textContent=n;
    }

    function prevPage(){if(S.pg>1){S.pg--;renderPg(S.pg);}}
    function nextPage(){if(S.pdfDoc&&S.pg<S.pdfDoc.numPages){S.pg++;renderPg(S.pg);}}
    function zoomIn(){S.zoom=Math.min(3,S.zoom+0.2);document.getElementById('zoomLevel').textContent=Math.round(S.zoom*100)+'%';renderPg(S.pg);}
    function zoomOut(){S.zoom=Math.max(0.3,S.zoom-0.2);document.getElementById('zoomLevel').textContent=Math.round(S.zoom*100)+'%';renderPg(S.pg);}
    function setupDD(){const p=document.getElementById('pdfPanel');p.addEventListener('dragover',e=>{e.preventDefault();p.classList.add('drop-zone-active');});p.addEventListener('dragleave',()=>p.classList.remove('drop-zone-active'));p.addEventListener('drop',async e=>{e.preventDefault();p.classList.remove('drop-zone-active');const f=e.dataTransfer.files[0];if(f?.type==='application/pdf')await loadPDF(f);else toast('Drop a PDF','error');});}

    // ===== PDF SECTION PARSER =====
    function parseSections(text){
        const sec={clinicalDx:null,finalDx:null,diffDx:null,diffList:[],labData:null,diagTesting:null,mgmtDisc:null,full:text};
        const targets=[
            {k:'clinicalDx',re:[/Clinical\s+Diagnos[ie]s/i,/Clinical\s+Impression/i]},
            {k:'finalDx',re:[/Final\s+Diagnos[ie]s/i,/Pathological\s+Diagnos[ie]s/i,/Anatomical\s+Diagnos[ie]s/i]},
            {k:'diffDx',re:[/Differential\s+Diagnos[ie]s/i]},
            {k:'labData',re:[/Laboratory\s+Data/i,/Laboratory\s+Results/i]},
            {k:'diagTesting',re:[/Diagnostic\s+Testing/i,/Diagnostic\s+Studies/i,/Imaging\s+Studies/i]},
            {k:'mgmtDisc',re:[/Discussion\s+of\s+Management/i,/Management\s+Discussion/i]}
        ];
        const bounds=[/Presentation\s+of\s+Case/i,/Hospital\s+Course/i,/Discussion(?!\s+of)/i,/Pathological\s+Discussion/i,/Radiologic/i,/Follow[\s-]?up/i,/References/i,/Physical\s+Exam/i,/History/i];
        const allH=[];
        for(const t of targets)for(const r of t.re){const m=text.match(r);if(m){allH.push({k:t.k,i:m.index,l:m[0].length});break;}}
        for(const r of bounds){const re=new RegExp(r.source,'gi');let m;while((m=re.exec(text))!==null)allH.push({k:'_',i:m.index,l:m[0].length});}
        allH.sort((a,b)=>a.i-b.i);
        for(const h of allH){
            if(h.k==='_')continue;
            const start=h.i+h.l;const next=allH.find(x=>x.i>h.i);const end=next?next.i:Math.min(start+3000,text.length);
            let content=text.substring(start,end).replace(/^[\s:;\-‚Äì‚Äî]+/,'').trim();
            if(h.k==='finalDx'||h.k==='clinicalDx'){
                const lines=content.split(/\n/).map(l=>l.trim()).filter(l=>l.length>2);const dxL=[];
                for(const l of lines){if(l.length>200||/^(Discussion|Hospital|The patient|This case|Dr\.|In this|A )/i.test(l))break;dxL.push(l);if(dxL.length>=5)break;}
                sec[h.k]=dxL.length?dxL.join('; ').replace(/\s+/g,' '):content.substring(0,300);
            }else if(h.k==='diffDx'){sec.diffDx=content.substring(0,3000);sec.diffList=extractDiffList(content);
            }else{sec[h.k]=content.substring(0,2000);}
        }
        return sec;
    }
    function extractDiffList(text){
        const dx=[];const lines=text.split(/\n/);
        for(const line of lines){const t=line.trim();if(!t||t.length<3||t.length>120)continue;
            const num=t.match(/^\d+[\.\)]\s*(.+)/);if(num){dx.push(num[1].trim());continue;}
            const bul=t.match(/^[‚Ä¢\-\*]\s*(.+)/);if(bul){dx.push(bul[1].trim());continue;}
            if(t.length<=80&&/^[A-Z]/.test(t)&&!/^(The|This|It|In|A|An|However|Although|Because|Dr\.|Figure|Table)/i.test(t)&&!/\b(was|were|is|are|has|had|the patient|showed|revealed)\b/i.test(t))dx.push(t.replace(/\.$/,''));
        }
        return[...new Set(dx.map(d=>d.replace(/\s+/g,' ').trim()))].filter(d=>d.length>2&&d.length<100);
    }

    function renderParsedPreview(){
        const c=document.getElementById('parsedSectionsPreview');if(!S.parsed){c.innerHTML='';return;}
        const secs=[{k:'finalDx',l:'Final Diagnosis',ic:'üéØ'},{k:'clinicalDx',l:'Clinical Diagnosis',ic:'üè•'},{k:'diffDx',l:'Differential Diagnosis',ic:'ü§î'},{k:'labData',l:'Laboratory Data',ic:'üß™'},{k:'diagTesting',l:'Diagnostic Testing',ic:'ü©ª'},{k:'mgmtDisc',l:'Management',ic:'üíä'}];
        // START COLLAPSED by default ‚Äî don't reveal answers
        let h='<div class="section-card"><div class="section-header collapsed" onclick="toggleSection(this)"><h3>üìÑ Detected Sections (contains spoilers)</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body collapsed">';
        for(const s of secs){const f=!!S.parsed[s.k];const pv=f?(typeof S.parsed[s.k]==='string'?S.parsed[s.k]:'').substring(0,120).replace(/\n/g,' '):'Not found';
            h+=`<div class="parsed-section"><div class="parsed-section-header">${s.ic} ${s.l} <span class="${f?'found':'missing'}">${f?'‚úì':'‚úó'}</span></div><div class="parsed-section-body">${esc(pv)}${pv.length>=120?'...':''}</div>`;
            if(s.k==='diffDx'&&S.parsed.diffList.length){h+='<ul class="diff-dx-list">';for(const d of S.parsed.diffList)h+=`<li class="diff-dx-item">${esc(d)}</li>`;h+='</ul>';}
            h+='</div>';}
        h+='</div></div>';c.innerHTML=h;
    }

    // TABS
    function setupTabs(){document.querySelectorAll('.workspace-tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.workspace-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('tab-'+t.dataset.tab).classList.add('active');}));}
    function toggleSection(h){h.classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
    function setPhase(p){S.phase=p;document.querySelectorAll('.phase-step').forEach((e,i)=>e.className='phase-step'+(i<p?' completed':'')+(i===p?' active':''));document.querySelectorAll('.phase-label').forEach((e,i)=>e.classList.toggle('active',i===p));}

    // DX
    function addDx(){const i=document.getElementById('dxInput'),t=i.value.trim();if(!t)return;S.dx.push({id:S.nid++,text:t,out:false});i.value='';i.focus();renderDxList();}
    function rmDx(id){S.dx=S.dx.filter(d=>d.id!==id);renderDxList();}
    function toggleOut(id){const d=S.dx.find(x=>x.id===id);if(d)d.out=!d.out;renderDxList();}
    function moveDx(id,dir){const i=S.dx.findIndex(d=>d.id===id),j=i+dir;if(i<0||j<0||j>=S.dx.length)return;[S.dx[i],S.dx[j]]=[S.dx[j],S.dx[i]];renderDxList();}
    function renderDxList(){const l=document.getElementById('dxList');badges();if(!S.dx.length){l.innerHTML='';l.appendChild(mkE('üéØ','No diagnoses yet.'));return;}l.innerHTML='';S.dx.forEach((d,i)=>{const li=document.createElement('li');li.className='dx-item'+(d.out?' dx-ruled-out':'');li.draggable=true;li.dataset.id=d.id;li.addEventListener('dragstart',dDS);li.addEventListener('dragover',dDO);li.addEventListener('drop',dDD);li.addEventListener('dragend',dDE);li.innerHTML=`<span class="dx-drag-handle">‚†ø</span><span class="dx-rank ${i===0&&!d.out?'top':''}">${i+1}</span><span class="dx-text">${esc(d.text)}</span>${d.out?'<span class="answer-tag incorrect">Out</span>':''}<div class="dx-actions"><button class="btn btn-ghost btn-icon" onclick="moveDx(${d.id},-1)">‚ñ≤</button><button class="btn btn-ghost btn-icon" onclick="moveDx(${d.id},1)">‚ñº</button><button class="btn btn-ghost btn-icon" onclick="toggleOut(${d.id})">${d.out?'‚ôª':'üö´'}</button><button class="btn btn-ghost btn-icon" onclick="rmDx(${d.id})">üóë</button></div>`;l.appendChild(li);});}
    let did=null;function dDS(e){did=+e.currentTarget.dataset.id;e.currentTarget.classList.add('dragging');}function dDO(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}function dDD(e){e.preventDefault();const t=+e.currentTarget.dataset.id;if(did==null||did===t)return;const fi=S.dx.findIndex(d=>d.id===did),ti=S.dx.findIndex(d=>d.id===t);const[m]=S.dx.splice(fi,1);S.dx.splice(ti,0,m);renderDxList();}function dDE(){did=null;document.querySelectorAll('.dx-item').forEach(e=>e.classList.remove('dragging','drag-over'));}

    // TESTS
    function addTest(){const i=document.getElementById('testInput'),n=i.value.trim();if(!n)return;S.tests.push({id:S.nid++,name:n,cat:document.getElementById('testCat').value,rat:document.getElementById('testRat').value.trim()});i.value='';document.getElementById('testRat').value='';i.focus();renderTestList();}
    function rmTest(id){S.tests=S.tests.filter(t=>t.id!==id);renderTestList();}
    function renderTestList(){const l=document.getElementById('testList');badges();const ic={lab:'üß™',imaging:'ü©ª',procedure:'üî¨',other:'üìã'};if(!S.tests.length){l.innerHTML='';l.appendChild(mkE('üß™','No tests.'));return;}l.innerHTML='';S.tests.forEach(t=>{const li=document.createElement('li');li.className='item-entry';li.innerHTML=`<span class="item-icon">${ic[t.cat]||'üìã'}</span><div class="item-content"><div class="item-name">${esc(t.name)}</div>${t.rat?`<div class="item-rationale">${esc(t.rat)}</div>`:''}</div><span class="item-category cat-${t.cat}">${t.cat}</span><button class="btn btn-ghost btn-icon" onclick="rmTest(${t.id})">üóë</button>`;l.appendChild(li);});}

    // MGMT
    function addMgmt(){const i=document.getElementById('mgmtInput'),n=i.value.trim();if(!n)return;S.mgmt.push({id:S.nid++,name:n,cat:document.getElementById('mgmtCat').value,rat:document.getElementById('mgmtRat').value.trim()});i.value='';document.getElementById('mgmtRat').value='';i.focus();renderMgmtList();}
    function rmMgmt(id){S.mgmt=S.mgmt.filter(m=>m.id!==id);renderMgmtList();}
    function renderMgmtList(){const l=document.getElementById('mgmtList');badges();const ic={medication:'üíä',intervention:'üè•',consult:'üìû',other:'üìã'};if(!S.mgmt.length){l.innerHTML='';l.appendChild(mkE('üíä','No management.'));return;}l.innerHTML='';S.mgmt.forEach(m=>{const li=document.createElement('li');li.className='item-entry';li.innerHTML=`<span class="item-icon">${ic[m.cat]||'üìã'}</span><div class="item-content"><div class="item-name">${esc(m.name)}</div>${m.rat?`<div class="item-rationale">${esc(m.rat)}</div>`:''}</div><span class="item-category cat-${m.cat}">${m.cat}</span><button class="btn btn-ghost btn-icon" onclick="rmMgmt(${m.id})">üóë</button>`;l.appendChild(li);});}
    function badges(){document.getElementById('dxCount').textContent=S.dx.length;document.getElementById('testCount').textContent=S.tests.length;document.getElementById('mgmtCount').textContent=S.mgmt.length;document.getElementById('workupCount').textContent=S.dx.length+S.tests.length+S.mgmt.length;}

    // ===== EXTRACTION =====
    async function extractCase(){
        if(!S.pdfText.trim()){toast('Load a PDF first.','error');return;}
        const btn=document.getElementById('extractBtn'),orig=btn.innerHTML;btn.innerHTML='<span class="spinner"></span> Extracting...';btn.disabled=true;
        try{
            if(!S.parsed)S.parsed=parseSections(S.pdfText);
            const answer = {
    finalDx: normalizeDxText(S.parsed.finalDx || ''),
    clinicalDx: normalizeDxText(S.parsed.clinicalDx || ''),
    differentials: S.parsed.diffList.length ? [...S.parsed.diffList] : [],
    labs: [],
    diagnosticTests: [],
    treatments: []
};
            if(S.llm!=='none'&&(S.key||S.llm==='ollama')){
                try{
                    const d=await llmExtract(S.parsed);
                    if(d.labs?.length)answer.labs=d.labs;
                    if(d.diagnosticTests?.length)answer.diagnosticTests=d.diagnosticTests;
                    if(d.treatments?.length)answer.treatments=d.treatments;
                    if(!answer.differentials.length&&d.differentials?.length)answer.differentials=d.differentials;
                    if (!answer.finalDx && d.finalDx) answer.finalDx = normalizeDxText(d.finalDx);
if (!answer.clinicalDx && d.clinicalDx) answer.clinicalDx = normalizeDxText(d.clinicalDx);
                }catch(e){console.warn('LLM fail:',e);toast('LLM failed ‚Äî using parsed data.','warning');}
            }
            S.answer=answer;renderAK();toast('‚úÖ Extracted!','success');
            document.querySelectorAll('.workspace-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
            document.querySelector('[data-tab="scoring"]').classList.add('active');document.getElementById('tab-scoring').classList.add('active');
        }catch(err){toast('Error: '+err.message,'error');}finally{btn.innerHTML=orig;btn.disabled=false;}
    }

    async function llmExtract(parsed){
        const prompt=`Extract structured data from these medical case sections. Return ONLY valid JSON.
{"finalDx":"diagnosis name only (e.g. \"Eosinophilic granulomatosis with polyangiitis\")",
 "clinicalDx":"diagnosis name only",
 "differentials":["name only"],
 "labs":["test: result"],
 "diagnosticTests":["procedure name"],
 "treatments":["treatment"]}
IMPORTANT:
- finalDx and clinicalDx MUST be just the diagnosis name, not full sentences, not labels like "Final Diagnosis", and not explanations.
${parsed.finalDx?`FINAL DIAGNOSIS:\n${parsed.finalDx}\n\n`:''}${parsed.clinicalDx?`CLINICAL DIAGNOSIS:\n${parsed.clinicalDx}\n\n`:''}${parsed.diffDx?`DIFFERENTIAL DIAGNOSIS:\n${parsed.diffDx.substring(0,2000)}\n\n`:''}${parsed.labData?`LABORATORY DATA:\n${parsed.labData.substring(0,1500)}\n\n`:''}${parsed.diagTesting?`DIAGNOSTIC TESTING:\n${parsed.diagTesting.substring(0,1500)}\n\n`:''}${parsed.mgmtDisc?`MANAGEMENT:\n${parsed.mgmtDisc.substring(0,1500)}\n\n`:''}`;
        const r=await callLLM(prompt);return parseLLM(r.content);
    }

    async function callLLM(p){switch(S.llm){case 'openrouter':return await fetchOR(p);case 'gemini':return{content:await fetchGem(p)};case 'openai':return{content:await fetchOAI(p)};case 'ollama':return{content:await fetchOll(p)};default:throw new Error('No LLM');}}
    async function fetchOAI(p){const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${S.key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:p}],temperature:0.2,max_tokens:2000})});if(!r.ok)throw new Error(`HTTP ${r.status}`);return(await r.json()).choices[0].message.content;}
    async function fetchGem(p){const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${S.key}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}],generationConfig:{temperature:0.2,maxOutputTokens:2000}})});if(!r.ok)throw new Error(`HTTP ${r.status}`);return(await r.json()).candidates[0].content.parts[0].text;}
    async function fetchOll(p){const r=await fetch(`${S.ollamaUrl}/api/generate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:S.ollamaModel,prompt:p,stream:false})});if(!r.ok)throw new Error(`HTTP ${r.status}`);return(await r.json()).response;}
    async function fetchOR(p){const body={model:S.orModel,messages:[{role:'user',content:p}],temperature:0.2,max_tokens:3000};dlog(`‚Üí ${body.model}`);const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${S.key}`,'HTTP-Referer':window.location.href,'X-Title':'CaseDx'},body:JSON.stringify(body)});const rt=await r.text();if(!r.ok){let d;try{d=JSON.parse(rt).error?.message;}catch(e){d=rt.substring(0,200);}throw new Error(d||`HTTP ${r.status}`);}const data=JSON.parse(rt);if(!data.choices?.length)throw new Error('Empty');return{content:data.choices[0].message.content||''};}
    function parseLLM(text){try{let s=text;const m1=s.match(/```(?:json)?\s*([\s\S]*?)```/);if(m1)s=m1[1];const m2=s.match(/\{[\s\S]*\}/);if(m2)s=m2[0];const p=JSON.parse(s);return{finalDx:p.finalDx||p.finalDiagnosis||'',clinicalDx:p.clinicalDx||p.clinicalDiagnosis||'',differentials:Array.isArray(p.differentials)?p.differentials:[],labs:Array.isArray(p.labs)?p.labs:[],diagnosticTests:Array.isArray(p.diagnosticTests)?p.diagnosticTests:[],treatments:Array.isArray(p.treatments)?p.treatments:[]};}catch(e){return{finalDx:'',clinicalDx:'',differentials:[],labs:[],diagnosticTests:[],treatments:[]};}}

    function normalizeDxText(raw) {
        if (!raw) return raw;
        let s = String(raw);

        // If there is an explicit "Final Diagnosis" label, take the text after it
        const labelMatch = s.match(/Final\s+Diagnosis[^:]*[:.]?\s*(.+)/i);
        if (labelMatch) {
            s = labelMatch[1];
        }

        // Stop at the first period to avoid pulling in whole sentences after the dx
        const firstSentence = s.split(/[.]/)[0];

        // Remove some common boilerplate tails if they slipped in
        let cleaned = firstSentence.replace(/This case was presented.*$/i, '');

        // Collapse whitespace and trim
        cleaned = cleaned.replace(/\s+/g, ' ').trim();

        return cleaned;
    }
        
    // ===== ANSWER KEY DISPLAY =====
    function renderAK(){
        const c=document.getElementById('answerKeyDisplay');
        if(!S.answer){c.innerHTML=`<div class="empty-state"><div class="empty-icon">üìä</div><p>Load a PDF and click ü§ñ Extract to build the answer key.</p></div><button class="btn btn-outline" onclick="createManualAK()" style="width:100%;margin-top:8px;">üìù Enter Manually</button>`;return;}
        const a=S.answer;
        c.innerHTML=`
            <div class="ak-card ak-dx-card"><div class="ak-card-header">üéØ Final Diagnosis</div><div class="ak-card-body"><div class="ak-dx-value">${a.finalDx?esc(a.finalDx):'<span class="ak-empty">Not found</span>'}</div></div></div>
            <div class="ak-card ak-clinical-card"><div class="ak-card-header">üè• Clinical Diagnosis</div><div class="ak-card-body"><div class="ak-dx-value">${a.clinicalDx?esc(a.clinicalDx):'<span class="ak-empty">Not found</span>'}</div></div></div>
            <div class="ak-card ak-diff-card"><div class="ak-card-header">ü§î Differentials (${a.differentials.length})</div><div class="ak-card-body">${a.differentials.length?`<ul class="ak-list">${a.differentials.map(d=>`<li><span>‚Ä¢</span>${esc(d)}</li>`).join('')}</ul>`:'<div class="ak-empty">None</div>'}</div></div>
            <div class="ak-card ak-lab-card"><div class="ak-card-header">üß™ Laboratory Data (${a.labs.length})</div><div class="ak-card-body">${
    a.labs.length ? `
        <ul class="ak-list">
            ${a.labs.map(l => {
                if (typeof l === 'string') {
                    // Backwards compatible: plain string from parser or LLM
                    return `<li><span>üî¨</span>${esc(l)}</li>`;
                }
                if (l && typeof l === 'object') {
                    // Try common shapes from LLM output
                    const name  = l.name  || l.test  || '';
                    const value = l.value || l.result || l.abnormality || '';
                    const extra = l.note  || l.comment || '';

                    const main = [name, value].filter(Boolean).join(': ');
                    const full = [main, extra].filter(Boolean).join(' ‚Äî ');

                    // Fallback to JSON if we still don't have anything readable
                    const text = full || JSON.stringify(l);
                    return `<li><span>üî¨</span>${esc(text)}</li>`;
                }
                // Last-resort fallback
                return `<li><span>üî¨</span>${esc(String(l))}</li>`;
            }).join('')}
        </ul>
    ` : '<div class="ak-empty">None</div>'
}</div></div>
            <div class="ak-card ak-test-card"><div class="ak-card-header">ü©ª Diagnostic Testing (${a.diagnosticTests.length})</div><div class="ak-card-body">${a.diagnosticTests.length?`<ul class="ak-list">${a.diagnosticTests.map(t=>`<li><span>üìã</span>${esc(t)}</li>`).join('')}</ul>`:'<div class="ak-empty">None</div>'}</div></div>
            <div class="ak-card ak-tx-card"><div class="ak-card-header">üíä Management (${a.treatments.length})</div><div class="ak-card-body">${a.treatments.length?`<ul class="ak-list">${a.treatments.map(t=>`<li><span>üíâ</span>${esc(t)}</li>`).join('')}</ul>`:'<div class="ak-empty">None</div>'}</div></div>
            <div style="display:flex;gap:8px;margin-top:12px;"><button class="btn btn-success" onclick="scoreCase()" style="flex:1;">üìä Score My Case</button><button class="btn btn-outline btn-sm" onclick="createManualAK()">‚úè Edit</button><button class="btn btn-outline btn-sm" onclick="extractCase()">üîÑ Re-extract</button></div>`;
    }

    function createManualAK(){
        if(!S.answer)S.answer={finalDx:'',clinicalDx:'',differentials:[],labs:[],diagnosticTests:[],treatments:[]};
        const a=S.answer,c=document.getElementById('answerKeyDisplay');
        c.innerHTML=`<div class="section-card"><div class="section-header"><h3>‚úè Edit Answer Key</h3></div><div class="section-body">
            <div class="form-group"><label>üéØ Final Diagnosis</label><input type="text" id="eFD" value="${esc(a.finalDx)}"></div>
            <div class="form-group"><label>üè• Clinical Diagnosis</label><input type="text" id="eCD" value="${esc(a.clinicalDx)}"></div>
            <div class="form-group"><label>ü§î Differentials (one per line)</label><textarea id="eDf" style="width:100%;min-height:80px;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;font-family:inherit;">${a.differentials.join('\n')}</textarea></div>
            <div class="form-group"><label>üß™ Labs (one per line)</label><textarea id="eLb" style="width:100%;min-height:80px;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;font-family:inherit;">${a.labs.join('\n')}</textarea></div>
            <div class="form-group"><label>ü©ª Diagnostic Testing (one per line)</label><textarea id="eDt" style="width:100%;min-height:80px;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;font-family:inherit;">${a.diagnosticTests.join('\n')}</textarea></div>
            <div class="form-group"><label>üíä Treatments (one per line)</label><textarea id="eTx" style="width:100%;min-height:80px;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;font-family:inherit;">${a.treatments.join('\n')}</textarea></div>
            <div style="display:flex;gap:8px;"><button class="btn btn-success" onclick="saveManualAK()" style="flex:1;">üíæ Save</button><button class="btn btn-ghost" onclick="renderAK()">Cancel</button></div>
        </div></div>`;
    }
    function saveManualAK(){const p=id=>document.getElementById(id).value.split('\n').map(s=>s.trim()).filter(Boolean);S.answer={finalDx:document.getElementById('eFD').value.trim(),clinicalDx:document.getElementById('eCD').value.trim(),differentials:p('eDf'),labs:p('eLb'),diagnosticTests:p('eDt'),treatments:p('eTx')};renderAK();toast('Saved!','success');}

    // ===== SCORING =====
    function scoreCase(){
        if(!S.answer?.finalDx){toast('Need Final Diagnosis.','error');return;}
        const a=S.answer,all=[...a.labs,...a.diagnosticTests];
        const dS=calcDxS(a.finalDx,a.differentials,a.clinicalDx),tS=calcLS(S.tests.map(t=>t.name),all),mS=calcLS(S.mgmt.map(m=>m.name),a.treatments);
        const ov=Math.round((dS.score+tS.score+mS.score)/3);
        const c=document.getElementById('scoreResults');c.style.display='block';document.getElementById('answerKeyDisplay').style.display='none';
        c.innerHTML=`
            <div class="dx-compare"><div class="dx-compare-card clinical"><div class="dx-type">üè• Clinical Dx</div><div class="dx-value">${a.clinicalDx?esc(a.clinicalDx):'N/A'}</div></div><div class="dx-compare-card final"><div class="dx-type">üéØ Final Dx</div><div class="dx-value">${esc(a.finalDx)}</div></div></div>
            <div class="score-card"><h3>Performance</h3><div class="score-grid"><div class="score-item"><div class="score-value ${sc(dS.score)}">${dS.score}%</div><div class="score-label">Diagnosis</div></div><div class="score-item"><div class="score-value ${sc(tS.score)}">${tS.score}%</div><div class="score-label">Testing</div></div><div class="score-item"><div class="score-value ${sc(mS.score)}">${mS.score}%</div><div class="score-label">Management</div></div></div><div style="text-align:center;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);"><div class="score-value ${sc(ov)}" style="font-size:2.5rem;">${ov}%</div><div class="score-label" style="font-size:0.85rem;">Overall</div></div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üéØ Diagnosis</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><p><strong>Final:</strong> ${esc(a.finalDx)}</p>${a.clinicalDx?`<p style="font-size:0.85rem;color:var(--gray-500);margin-top:4px;"><strong>Clinical:</strong> ${esc(a.clinicalDx)}</p>`:''}<p style="margin:8px 0;font-size:0.85rem;color:var(--gray-500);">${dS.detail}</p>${S.dx.length?`<table class="comparison-table"><tr><th>#</th><th>Your Differential</th><th>Match</th></tr>${S.dx.map((d,i)=>`<tr><td>${i+1}</td><td class="${d.out?'match-no':''}">${esc(d.text)}${d.out?' (out)':''}</td><td>${dxTag(d.text,a.finalDx,a.clinicalDx,a.differentials)}</td></tr>`).join('')}</table>`:'<p style="color:var(--gray-400)">None entered.</p>'}</div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üß™ Testing</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">${cmpL('Yours',S.tests.map(t=>t.name),'Key',all)}</div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üíä Management</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">${cmpL('Yours',S.mgmt.map(m=>m.name),'Key',a.treatments)}</div></div>
            <button class="btn btn-outline" onclick="document.getElementById('scoreResults').style.display='none';document.getElementById('answerKeyDisplay').style.display='block';" style="width:100%;margin-top:8px;">‚Üê Back to Answer Key</button>`;
    }
    function calcDxS(c,d,cl){if(!S.dx.length)return{score:0,detail:'No diagnoses entered.'};const a=S.dx.filter(x=>!x.out);if(!a.length)return{score:0,detail:'All ruled out.'};if(fz(a[0].text,c))return{score:100,detail:'#1 matches Final Dx! üéâ'};const mi=a.findIndex(x=>fz(x.text,c));if(mi>0)return{score:Math.max(20,85-mi*15),detail:`Final Dx was #${mi+1}.`};if(cl&&fz(a[0].text,cl))return{score:60,detail:'#1 matches Clinical Dx but not Final.'};const dm=a.filter(x=>d.some(df=>fz(x.text,df))).length;if(dm)return{score:Math.min(40,dm*15),detail:`${dm} on diff but missed Final.`};return{score:0,detail:'Final Dx not on differential.'};}
    function calcLS(u,a){if(!a.length)return{score:100};if(!u.length)return{score:0};let m=0;a.forEach(x=>{if(u.some(y=>fz(y,x)))m++;});return{score:Math.round(m/a.length*100)};}
    function fz(a,b){a=a.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();b=b.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();if(a===b||a.includes(b)||b.includes(a))return true;const wa=a.split(/\s+/).filter(w=>w.length>2),wb=b.split(/\s+/).filter(w=>w.length>2);if(!wa.length||!wb.length)return false;return wa.filter(w=>wb.some(x=>x.includes(w)||w.includes(x))).length>=Math.min(2,Math.ceil(wb.length*0.6));}
    function dxTag(u,f,c,d){if(fz(u,f))return'<span class="answer-tag correct">‚úì Final</span>';if(c&&fz(u,c))return'<span class="answer-tag partial">~ Clinical</span>';if(d.some(x=>fz(u,x)))return'<span class="answer-tag partial">~ Diff</span>';return'<span class="answer-tag incorrect">‚úó</span>';}
    function cmpL(ul,ui,al,ai){let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';h+=`<div><h4 style="font-size:0.85rem;margin-bottom:8px;color:var(--gray-600)">${ul}</h4>`;if(!ui.length)h+='<p style="color:var(--gray-400);font-size:0.85rem">None</p>';else ui.forEach(x=>{const m=ai.some(a=>fz(x,a));h+=`<div style="padding:3px 0;font-size:0.85rem">${m?'<span class="match-yes">‚úì</span>':'<span class="match-no">‚óã</span>'} ${esc(x)}</div>`;});h+='</div>';h+=`<div><h4 style="font-size:0.85rem;margin-bottom:8px;color:var(--gray-600)">${al}</h4>`;if(!ai.length)h+='<p style="color:var(--gray-400);font-size:0.85rem">None</p>';else ai.forEach(x=>{const m=ui.some(u=>fz(u,x));h+=`<div style="padding:3px 0;font-size:0.85rem">${m?'<span class="match-yes">‚úì</span>':'<span class="match-no">‚úó</span>'} ${esc(x)}</div>`;});h+='</div></div>';return h;}
    function sc(s){return s>=70?'good':s>=40?'okay':'poor';}

    // SETTINGS
    function openSettings(){document.getElementById('settingsModal').classList.add('show');document.querySelectorAll('input[name="llmProvider"]').forEach(r=>r.checked=r.value===S.llm);document.getElementById('apiKeyInput').value=S.key;document.getElementById('ollamaUrl').value=S.ollamaUrl;document.getElementById('ollamaModel').value=S.ollamaModel;document.getElementById('orModelInput').value=S.orModel;updateSUI();document.querySelectorAll('input[name="llmProvider"]').forEach(r=>r.addEventListener('change',updateSUI));}
    function closeSettings(){document.getElementById('settingsModal').classList.remove('show');}
    function updateSUI(){const p=document.querySelector('input[name="llmProvider"]:checked').value;document.getElementById('apiKeyGroup').style.display=['openai','gemini','openrouter'].includes(p)?'block':'none';document.getElementById('ollamaGroup').style.display=p==='ollama'?'block':'none';document.getElementById('openrouterGroup').style.display=p==='openrouter'?'block':'none';const l={openrouter:'<a href="https://openrouter.ai/keys" target="_blank" style="color:var(--primary)">Get key</a>',gemini:'<a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary)">Get key</a>',openai:'<a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--primary)">Get key</a>'};document.getElementById('apiKeyHelp').innerHTML=l[p]||'';}
    function saveSettings(){S.llm=document.querySelector('input[name="llmProvider"]:checked').value;S.key=document.getElementById('apiKeyInput').value.trim();S.ollamaUrl=document.getElementById('ollamaUrl').value.trim();S.ollamaModel=document.getElementById('ollamaModel').value.trim();S.orModel=document.getElementById('orModelInput').value.trim();localStorage.setItem('casedx',JSON.stringify({llm:S.llm,key:S.key,ou:S.ollamaUrl,om:S.ollamaModel,or:S.orModel}));updateStatus();dismissBanner();closeSettings();toast('Saved!','success');}
    function loadSettings(){try{const s=JSON.parse(localStorage.getItem('casedx'));if(s){S.llm=s.llm||'openrouter';S.key=s.key||'';S.ollamaUrl=s.ou||'http://localhost:11434';S.ollamaModel=s.om||'llama3.2';S.orModel=s.or||'meta-llama/llama-3.1-8b-instruct';}}catch(e){}}
    function updateStatus(){const d=document.getElementById('llmDot'),n=document.getElementById('llmName');const nm={none:'Manual',openai:'OpenAI',gemini:'Gemini',ollama:'Ollama',openrouter:'OR'};let dn=nm[S.llm]||'None';if(S.llm==='openrouter'&&S.orModel)dn+=` ¬∑ ${S.orModel.split('/').pop()}`;n.textContent=dn;d.className=S.llm==='none'?'llm-dot':((S.key||S.llm==='ollama')?'llm-dot connected':'llm-dot needs-key');}
    function toggleKeyVis(){const i=document.getElementById('apiKeyInput');i.type=i.type==='password'?'text':'password';}
    async function testConn(){const p=document.querySelector('input[name="llmProvider"]:checked').value;const k=document.getElementById('apiKeyInput').value.trim();const m=document.getElementById('orModelInput').value.trim();dlog('--- TEST ---');if(p==='none')return;if(!k&&p!=='ollama'){toast('Enter key','error');return;}const old={k:S.key,p:S.llm,m:S.orModel};S.key=k;S.llm=p;S.orModel=m;S.ollamaUrl=document.getElementById('ollamaUrl').value.trim();S.ollamaModel=document.getElementById('ollamaModel').value.trim();const btn=document.getElementById('testBtn');btn.innerHTML='Testing...';btn.disabled=true;try{await callLLM('Say OK');dlog('SUCCESS!');toast('‚úÖ Works!','success');}catch(e){dlog(e.message,'error');toast('‚ùå '+e.message.substring(0,80),'error');S.key=old.k;S.llm=old.p;S.orModel=old.m;}finally{btn.innerHTML='üîå Test';btn.disabled=false;}}
    function setupResize(){const h=document.getElementById('resizeHandle'),p=document.getElementById('workspacePanel');let r=false;h.addEventListener('mousedown',()=>{r=true;h.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';});document.addEventListener('mousemove',e=>{if(!r)return;p.style.width=Math.max(380,Math.min(800,document.querySelector('.main-container').getBoundingClientRect().right-e.clientX))+'px';});document.addEventListener('mouseup',()=>{if(r){r=false;h.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';}});}
    function resetCase(){if(S.dx.length+S.tests.length+S.mgmt.length>0&&!confirm('Reset?'))return;Object.assign(S,{pdfDoc:null,pg:1,zoom:1,pdfText:'',parsed:null,dx:[],tests:[],mgmt:[],phase:0,answer:null,nid:1});document.getElementById('pdfToolbar').style.display='none';document.getElementById('pdfPlaceholder').style.display='flex';document.getElementById('pdfCanvasContainer').style.display='none';document.getElementById('pdfCanvasContainer').innerHTML='';document.getElementById('zoomLevel').textContent='100%';document.getElementById('parsedSectionsPreview').innerHTML='';['hpiNotes','examNotes','generalNotes'].forEach(id=>document.getElementById(id).value='');document.getElementById('scoreResults').style.display='none';document.getElementById('pdfInput').value='';setPhase(0);renderDxList();renderTestList();renderMgmtList();renderAK();document.querySelectorAll('.workspace-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));document.querySelector('.workspace-tab').classList.add('active');document.getElementById('tab-workup').classList.add('active');toast('Reset!','info');}
    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function mkE(i,m){const li=document.createElement('li');li.className='empty-state';li.innerHTML=`<div class="empty-icon">${i}</div><p>${m}</p>`;return li;}
    function toast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast toast-${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(100%)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},6000);}
    </script>
</body>
</html>

