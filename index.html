<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseDx ‚Äì Medical Case Simulator</title>
    <style>
        /* ===== CSS RESET & VARIABLES ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --success: #16a34a;
            --success-light: #dcfce7;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            --transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
            z-index: 100;
            position: relative;
            height: 52px;
        }

        .app-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-header h1 .icon {
            font-size: 1.4rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1.5px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary-light);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray-500);
            padding: 5px 8px;
        }

        .btn-ghost:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: 6px;
            min-width: 32px;
            justify-content: center;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
            overflow: hidden;
        }

        /* ===== LEFT PANEL - PDF VIEWER ===== */
        .pdf-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--gray-200);
            min-width: 300px;
            position: relative;
        }

        .pdf-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--gray-800);
            color: white;
            font-size: 0.85rem;
        }

        .pdf-toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pdf-toolbar .btn {
            color: white;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .pdf-toolbar .btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .pdf-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pdf-canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            gap: 10px;
        }

        .pdf-canvas-container canvas {
            box-shadow: var(--shadow-lg);
            max-width: 100%;
        }

        .pdf-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            color: var(--gray-400);
            text-align: center;
            padding: 40px;
        }

        .pdf-placeholder .upload-icon {
            font-size: 4rem;
            line-height: 1;
        }

        .pdf-placeholder h3 {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .pdf-placeholder p {
            font-size: 0.9rem;
            max-width: 320px;
        }

        .drop-zone-active .pdf-content {
            background: var(--primary-light);
            border: 3px dashed var(--primary);
        }

        /* ===== RESIZE HANDLE ===== */
        .resize-handle {
            width: 6px;
            background: var(--gray-300);
            cursor: col-resize;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background: var(--primary);
        }

        .resize-handle::after {
            content: '‚ãÆ';
            color: var(--gray-500);
            font-size: 1.2rem;
        }

        .resize-handle:hover::after,
        .resize-handle.active::after {
            color: white;
        }

        /* ===== RIGHT PANEL - WORKSPACE ===== */
        .workspace-panel {
            width: 520px;
            min-width: 380px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .workspace-tabs {
            display: flex;
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .workspace-tab {
            padding: 10px 16px;
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: var(--transition);
            white-space: nowrap;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .workspace-tab:hover {
            color: var(--gray-700);
            background: var(--gray-100);
        }

        .workspace-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .workspace-tab .badge {
            background: var(--gray-200);
            color: var(--gray-600);
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 700;
        }

        .workspace-tab.active .badge {
            background: var(--primary-light);
            color: var(--primary);
        }

        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* ===== SECTION CARDS ===== */
        .section-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            user-select: none;
        }

        .section-header h3 {
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header .collapse-icon {
            transition: transform 0.2s;
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .section-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .section-body {
            padding: 12px 14px;
        }

        .section-body.collapsed {
            display: none;
        }

        /* ===== INPUT GROUP ===== */
        .input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .input-group input,
        .input-group textarea {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.87rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input-group input::placeholder {
            color: var(--gray-400);
        }

        /* ===== DIAGNOSIS LIST ===== */
        .dx-list {
            list-style: none;
        }

        .dx-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: grab;
            user-select: none;
        }

        .dx-item:active {
            cursor: grabbing;
        }

        .dx-item.dragging {
            opacity: 0.5;
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .dx-item.drag-over {
            border-top: 2px solid var(--primary);
        }

        .dx-rank {
            font-weight: 800;
            color: var(--primary);
            font-size: 0.85rem;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dx-rank.top {
            background: var(--success-light);
            color: var(--success);
        }

        .dx-drag-handle {
            color: var(--gray-400);
            cursor: grab;
            font-size: 1rem;
            flex-shrink: 0;
            padding: 0 2px;
        }

        .dx-text {
            flex: 1;
            font-size: 0.87rem;
            font-weight: 500;
        }

        .dx-confidence {
            font-size: 0.75rem;
            color: var(--gray-500);
            flex-shrink: 0;
        }

        .dx-actions {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
        }

        .dx-actions .btn-icon {
            font-size: 0.85rem;
            padding: 3px;
            min-width: 24px;
        }

        .dx-ruled-out {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .dx-ruled-out .dx-rank {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* ===== TEST / MANAGEMENT ITEMS ===== */
        .item-list {
            list-style: none;
        }

        .item-entry {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
        }

        .item-entry .item-icon {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .item-entry .item-content {
            flex: 1;
        }

        .item-entry .item-name {
            font-size: 0.87rem;
            font-weight: 600;
        }

        .item-entry .item-rationale {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .item-entry .item-category {
            font-size: 0.7rem;
            padding: 1px 8px;
            border-radius: 10px;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .cat-lab { background: #ede9fe; color: #7c3aed; }
        .cat-imaging { background: #e0f2fe; color: #0284c7; }
        .cat-procedure { background: #fce7f3; color: #db2777; }
        .cat-other { background: var(--gray-100); color: var(--gray-600); }
        .cat-medication { background: #dcfce7; color: #16a34a; }
        .cat-intervention { background: #fef3c7; color: #d97706; }
        .cat-consult { background: #e0e7ff; color: #4f46e5; }

        .item-entry .btn-icon {
            flex-shrink: 0;
        }

        /* ===== NOTES SECTION ===== */
        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px 12px;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.87rem;
            font-family: inherit;
            resize: vertical;
            transition: var(--transition);
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* ===== SCORE CARD ===== */
        .score-card {
            background: linear-gradient(135deg, var(--gray-800), var(--gray-900));
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .score-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-400);
            margin-bottom: 12px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 1.8rem;
            font-weight: 800;
        }

        .score-value.good { color: #4ade80; }
        .score-value.okay { color: #facc15; }
        .score-value.poor { color: #f87171; }

        .score-label {
            font-size: 0.75rem;
            color: var(--gray-400);
            margin-top: 2px;
        }

        /* ===== COMPARISON TABLE ===== */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 12px;
        }

        .comparison-table th {
            text-align: left;
            padding: 8px 10px;
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 700;
            font-size: 0.8rem;
        }

        .comparison-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .match-yes { color: var(--success); font-weight: 700; }
        .match-no { color: var(--danger); }
        .match-partial { color: var(--warning); }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--gray-700);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.87rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* ===== SETTINGS PANEL ===== */
        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h4 {
            font-size: 0.85rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gray-200);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border: 1.5px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .radio-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .radio-option input[type="radio"] {
            accent-color: var(--primary);
        }

        .radio-option .option-label {
            font-weight: 600;
            font-size: 0.87rem;
        }

        .radio-option .option-desc {
            font-size: 0.78rem;
            color: var(--gray-500);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 18px;
            border-radius: var(--radius);
            color: white;
            font-size: 0.87rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 360px;
        }

        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--gray-400);
        }

        .empty-state .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 0.85rem;
        }

        /* ===== LLM STATUS ===== */
        .llm-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            padding: 4px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }

        .llm-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-400);
        }

        .llm-dot.connected { background: #4ade80; }
        .llm-dot.error { background: #f87171; }

        /* ===== PROGRESS BAR ===== */
        .phase-bar {
            display: flex;
            gap: 2px;
            margin-bottom: 12px;
        }

        .phase-step {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            cursor: pointer;
            transition: var(--transition);
        }

        .phase-step.active {
            background: var(--primary);
        }

        .phase-step.completed {
            background: var(--success);
        }

        .phase-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .phase-label {
            font-size: 0.7rem;
            color: var(--gray-400);
            text-align: center;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .phase-label.active {
            color: var(--primary);
            font-weight: 700;
        }

        .phase-label:hover {
            background: var(--gray-100);
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .spinner.dark {
            border-color: var(--gray-200);
            border-top-color: var(--primary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ANSWER KEY TAG ===== */
        .answer-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .answer-tag.correct {
            background: var(--success-light);
            color: var(--success);
        }

        .answer-tag.incorrect {
            background: var(--danger-light);
            color: var(--danger);
        }

        .answer-tag.partial {
            background: var(--warning-light);
            color: var(--warning);
        }

        /* ===== SCROLLBAR ===== */
        .workspace-content::-webkit-scrollbar,
        .pdf-content::-webkit-scrollbar {
            width: 8px;
        }

        .workspace-content::-webkit-scrollbar-track,
        .pdf-content::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .workspace-content::-webkit-scrollbar-thumb,
        .pdf-content::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 4px;
        }

        .workspace-content::-webkit-scrollbar-thumb:hover,
        .pdf-content::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            .pdf-panel {
                height: 40vh;
                min-width: unset;
            }
            .workspace-panel {
                width: 100% !important;
                min-width: unset;
                max-width: unset;
                height: 60vh;
            }
            .resize-handle {
                width: 100%;
                height: 6px;
                cursor: row-resize;
            }
        }

        .hidden { display: none !important; }

        /* ===== EXTRACTION STATUS ===== */
        .extraction-status {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--radius);
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.87rem;
        }

        .extraction-status.error {
            background: var(--danger-light);
            border-color: var(--danger);
        }

        .extraction-status.success {
            background: var(--success-light);
            border-color: var(--success);
        }

        /* ===== KEY INPUT (for LLM) ===== */
        .key-input-wrapper {
            position: relative;
        }

        .key-input-wrapper input {
            padding-right: 40px;
        }

        .key-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-400);
            font-size: 1rem;
        }

        /* Confidence slider */
        .confidence-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--gray-200);
            border-radius: 2px;
            outline: none;
        }

        .confidence-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        /* Subtitle / helper text */
        .helper-text {
            font-size: 0.78rem;
            color: var(--gray-400);
            margin-bottom: 8px;
        }

        /* Tag / chip input for categories */
        .select-small {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            background: white;
        }
    </style>
</head>
<body>

    <!-- ===== HEADER ===== -->
    <header class="app-header">
        <h1>
            <span class="icon">ü©∫</span>
            CaseDx
        </h1>
        <div class="header-actions">
            <div class="llm-status" id="llmStatus">
                <span class="llm-dot" id="llmDot"></span>
                <span id="llmName">No LLM</span>
            </div>
            <label class="btn btn-primary" for="pdfInput" style="margin:0; cursor:pointer;">
                üìÑ Load Case PDF
            </label>
            <input type="file" id="pdfInput" accept=".pdf" style="display:none;">
            <button class="btn btn-secondary" onclick="openSettings()">‚öô Settings</button>
            <button class="btn btn-secondary" onclick="resetCase()">üîÑ New Case</button>
        </div>
    </header>

    <!-- ===== MAIN LAYOUT ===== -->
    <div class="main-container">

        <!-- PDF PANEL -->
        <div class="pdf-panel" id="pdfPanel">
            <div class="pdf-toolbar" id="pdfToolbar" style="display:none;">
                <div class="pdf-toolbar-group">
                    <button class="btn" onclick="prevPage()">‚óÄ</button>
                    <span>Page <span id="pageNum">1</span> of <span id="pageCount">1</span></span>
                    <button class="btn" onclick="nextPage()">‚ñ∂</button>
                </div>
                <div class="pdf-toolbar-group">
                    <button class="btn" onclick="zoomOut()">‚àí</button>
                    <span id="zoomLevel">100%</span>
                    <button class="btn" onclick="zoomIn()">+</button>
                    <button class="btn" onclick="extractWithLLM()" id="extractBtn" title="Extract case data with AI">ü§ñ Extract</button>
                </div>
            </div>
            <div class="pdf-content" id="pdfContent">
                <div class="pdf-placeholder" id="pdfPlaceholder">
                    <div class="upload-icon">üìã</div>
                    <h3>Load a Case PDF</h3>
                    <p>Click "Load Case PDF" above or drag & drop a PDF file here to begin your case analysis.</p>
                    <label class="btn btn-outline" for="pdfInput" style="cursor:pointer;">Choose File</label>
                </div>
                <div class="pdf-canvas-container" id="pdfCanvasContainer" style="display:none;"></div>
            </div>
        </div>

        <!-- RESIZE HANDLE -->
        <div class="resize-handle" id="resizeHandle"></div>

        <!-- WORKSPACE PANEL -->
        <div class="workspace-panel" id="workspacePanel">
            <div class="workspace-tabs">
                <button class="workspace-tab active" data-tab="workup">
                    üîç Workup <span class="badge" id="workupCount">0</span>
                </button>
                <button class="workspace-tab" data-tab="diagnoses">
                    üéØ Diagnoses <span class="badge" id="dxCount">0</span>
                </button>
                <button class="workspace-tab" data-tab="testing">
                    üß™ Testing <span class="badge" id="testCount">0</span>
                </button>
                <button class="workspace-tab" data-tab="management">
                    üíä Management <span class="badge" id="mgmtCount">0</span>
                </button>
                <button class="workspace-tab" data-tab="scoring">
                    üìä Score
                </button>
            </div>

            <div class="workspace-content">

                <!-- TAB: WORKUP (Overview / Notes) -->
                <div class="tab-pane active" id="tab-workup">
                    <!-- Phase Progress -->
                    <div class="section-card">
                        <div class="section-header" onclick="toggleSection(this)">
                            <h3>üìã Case Phase</h3>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="section-body">
                            <div class="phase-bar">
                                <div class="phase-step active" data-phase="0" onclick="setPhase(0)"></div>
                                <div class="phase-step" data-phase="1" onclick="setPhase(1)"></div>
                                <div class="phase-step" data-phase="2" onclick="setPhase(2)"></div>
                                <div class="phase-step" data-phase="3" onclick="setPhase(3)"></div>
                                <div class="phase-step" data-phase="4" onclick="setPhase(4)"></div>
                            </div>
                            <div class="phase-labels">
                                <span class="phase-label active" data-phase="0" onclick="setPhase(0)">HPI</span>
                                <span class="phase-label" data-phase="1" onclick="setPhase(1)">Exam</span>
                                <span class="phase-label" data-phase="2" onclick="setPhase(2)">Initial Dx</span>
                                <span class="phase-label" data-phase="3" onclick="setPhase(3)">Results</span>
                                <span class="phase-label" data-phase="4" onclick="setPhase(4)">Final Dx</span>
                            </div>
                        </div>
                    </div>

                    <!-- Key Findings -->
                    <div class="section-card">
                        <div class="section-header" onclick="toggleSection(this)">
                            <h3>üîë Key Findings / HPI Notes</h3>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="section-body">
                            <textarea class="notes-textarea" id="hpiNotes" placeholder="Jot down key findings from the history of present illness, vitals, pertinent positives and negatives..."></textarea>
                        </div>
                    </div>

                    <!-- Physical Exam Notes -->
                    <div class="section-card">
                        <div class="section-header" onclick="toggleSection(this)">
                            <h3>ü©ª Physical Exam Notes</h3>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="section-body">
                            <textarea class="notes-textarea" id="examNotes" placeholder="Note any abnormal physical exam findings, pertinent negatives..."></textarea>
                        </div>
                    </div>

                    <!-- Free Notes -->
                    <div class="section-card">
                        <div class="section-header" onclick="toggleSection(this)">
                            <h3>üìù General Notes</h3>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="section-body">
                            <textarea class="notes-textarea" id="generalNotes" placeholder="Any additional thoughts, reasoning, questions..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- TAB: DIAGNOSES -->
                <div class="tab-pane" id="tab-diagnoses">
                    <div class="helper-text">Rank your differential diagnoses from most to least likely. Drag to reorder.</div>

                    <div class="input-group">
                        <input type="text" id="dxInput" placeholder="Enter a diagnosis..." onkeydown="if(event.key==='Enter') addDiagnosis()">
                        <button class="btn btn-outline btn-sm" onclick="addDiagnosis()">+ Add</button>
                    </div>

                    <ul class="dx-list" id="dxList">
                        <li class="empty-state" id="dxEmpty">
                            <div class="empty-icon">üéØ</div>
                            <p>No diagnoses yet. Start building your differential!</p>
                        </li>
                    </ul>
                </div>

                <!-- TAB: TESTING -->
                <div class="tab-pane" id="tab-testing">
                    <div class="helper-text">Order the diagnostic tests you'd like. Be specific!</div>

                    <div class="input-group" style="flex-wrap:wrap;">
                        <input type="text" id="testInput" placeholder="e.g., CBC with diff, CT chest with contrast..." onkeydown="if(event.key==='Enter') addTest()" style="flex: 1; min-width: 200px;">
                        <select class="select-small" id="testCategory">
                            <option value="lab">üß™ Lab</option>
                            <option value="imaging">ü©ª Imaging</option>
                            <option value="procedure">üî¨ Procedure</option>
                            <option value="other">üìã Other</option>
                        </select>
                        <button class="btn btn-outline btn-sm" onclick="addTest()">+ Add</button>
                    </div>

                    <div class="form-group" style="margin-bottom: 14px;">
                        <input type="text" id="testRationale" placeholder="Rationale (optional) ‚Äî why are you ordering this?" style="width:100%; padding:6px 12px; border:1.5px solid var(--gray-300); border-radius:var(--radius); font-size:0.83rem;">
                    </div>

                    <ul class="item-list" id="testList">
                        <li class="empty-state" id="testEmpty">
                            <div class="empty-icon">üß™</div>
                            <p>No tests ordered yet.</p>
                        </li>
                    </ul>
                </div>

                <!-- TAB: MANAGEMENT -->
                <div class="tab-pane" id="tab-management">
                    <div class="helper-text">What treatments or interventions would you start?</div>

                    <div class="input-group" style="flex-wrap:wrap;">
                        <input type="text" id="mgmtInput" placeholder="e.g., IV NS bolus 1L, Ceftriaxone 1g IV..." onkeydown="if(event.key==='Enter') addManagement()" style="flex: 1; min-width: 200px;">
                        <select class="select-small" id="mgmtCategory">
                            <option value="medication">üíä Medication</option>
                            <option value="intervention">üè• Intervention</option>
                            <option value="consult">üìû Consult</option>
                            <option value="other">üìã Other</option>
                        </select>
                        <button class="btn btn-outline btn-sm" onclick="addManagement()">+ Add</button>
                    </div>

                    <div class="form-group" style="margin-bottom: 14px;">
                        <input type="text" id="mgmtRationale" placeholder="Rationale (optional)" style="width:100%; padding:6px 12px; border:1.5px solid var(--gray-300); border-radius:var(--radius); font-size:0.83rem;">
                    </div>

                    <ul class="item-list" id="mgmtList">
                        <li class="empty-state" id="mgmtEmpty">
                            <div class="empty-icon">üíä</div>
                            <p>No management plans yet.</p>
                        </li>
                    </ul>
                </div>

                <!-- TAB: SCORING -->
                <div class="tab-pane" id="tab-scoring">
                    <div id="noScoreYet">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>Score your case after extracting the answer key from the PDF using the ü§ñ Extract button, or manually enter the answer key below.</p>
                        </div>

                        <div class="section-card">
                            <div class="section-header" onclick="toggleSection(this)">
                                <h3>üìù Manual Answer Key</h3>
                                <span class="collapse-icon">‚ñº</span>
                            </div>
                            <div class="section-body">
                                <div class="form-group">
                                    <label>Final Diagnosis</label>
                                    <input type="text" id="answerDiagnosis" placeholder="The correct final diagnosis">
                                </div>
                                <div class="form-group">
                                    <label>Key Tests (comma-separated)</label>
                                    <input type="text" id="answerTests" placeholder="e.g., CT head, LP, blood cultures">
                                </div>
                                <div class="form-group">
                                    <label>Key Treatments (comma-separated)</label>
                                    <input type="text" id="answerTreatments" placeholder="e.g., IV antibiotics, surgical consult">
                                </div>
                                <div class="form-group">
                                    <label>Differential Diagnoses Considered (comma-separated)</label>
                                    <input type="text" id="answerDifferentials" placeholder="e.g., meningitis, SAH, migraine">
                                </div>
                                <button class="btn btn-success" onclick="scoreCase()" style="width:100%;">üìä Score My Case</button>
                            </div>
                        </div>
                    </div>

                    <div id="scoreResults" style="display:none;"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== SETTINGS MODAL ===== -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öô Settings</h2>
                <button class="btn btn-ghost" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <h4>LLM Provider</h4>
                    <div class="radio-group" id="llmProviderGroup">
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="none" checked>
                            <div>
                                <div class="option-label">None (Manual Mode)</div>
                                <div class="option-desc">No AI extraction ‚Äî enter answer key manually.</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="openai">
                            <div>
                                <div class="option-label">OpenAI (GPT-4o-mini)</div>
                                <div class="option-desc">Uses GPT-4o-mini. Requires API key.</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="anthropic">
                            <div>
                                <div class="option-label">Anthropic (Claude)</div>
                                <div class="option-desc">Uses Claude 3 Haiku. Requires API key.</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="gemini">
                            <div>
                                <div class="option-label">Google Gemini</div>
                                <div class="option-desc">Uses Gemini 1.5 Flash. Requires API key.</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="ollama">
                            <div>
                                <div class="option-label">Ollama (Local)</div>
                                <div class="option-desc">Free! Run locally. Default: llama3.2</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="llmProvider" value="openrouter">
                            <div>
                                <div class="option-label">OpenRouter</div>
                                <div class="option-desc">Access many models. Some free tiers available.</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="settings-group" id="apiKeyGroup" style="display:none;">
                    <h4>API Key</h4>
                    <div class="form-group">
                        <div class="key-input-wrapper">
                            <input type="password" id="apiKeyInput" placeholder="Enter your API key">
                            <button class="key-toggle" onclick="toggleKeyVisibility()">üëÅ</button>
                        </div>
                        <div style="font-size:0.75rem; color:var(--gray-400); margin-top:4px;">
                            Your key is stored locally in your browser and never sent anywhere except the provider's API.
                        </div>
                    </div>
                </div>

                <div class="settings-group" id="ollamaGroup" style="display:none;">
                    <h4>Ollama Settings</h4>
                    <div class="form-group">
                        <label>Ollama URL</label>
                        <input type="text" id="ollamaUrl" value="http://localhost:11434" placeholder="http://localhost:11434">
                    </div>
                    <div class="form-group">
                        <label>Model Name</label>
                        <input type="text" id="ollamaModel" value="llama3.2" placeholder="llama3.2">
                    </div>
                </div>

                <div class="settings-group" id="openrouterGroup" style="display:none;">
                    <h4>OpenRouter Settings</h4>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" id="openrouterModel" value="meta-llama/llama-3.1-8b-instruct:free" placeholder="model identifier">
                        <div style="font-size:0.75rem; color:var(--gray-400); margin-top:4px;">
                            Use ":free" suffix for free models, e.g., meta-llama/llama-3.1-8b-instruct:free
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- ===== TOAST CONTAINER ===== -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ===== PDF.js ===== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- ===== APP SCRIPT ===== -->
    <script>
        // ===== GLOBAL STATE =====
        const state = {
            // PDF
            pdfDoc: null,
            currentPage: 1,
            zoom: 1.0,
            pdfText: '',

            // User entries
            diagnoses: [],        // {id, text, ruledOut, confidence}
            tests: [],            // {id, name, category, rationale}
            management: [],       // {id, name, category, rationale}
            currentPhase: 0,

            // Answer key (from LLM or manual)
            answerKey: null,      // {diagnosis, differentials[], tests[], treatments[]}

            // Settings
            llmProvider: 'none',
            apiKey: '',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: 'llama3.2',
            openrouterModel: 'meta-llama/llama-3.1-8b-instruct:free',

            // Internal
            nextId: 1
        };

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            loadSettings();
            setupTabs();
            setupDragDrop();
            setupResize();
            updateLLMStatus();
        });

        // ===== PDF LOADING =====
        document.getElementById('pdfInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            await loadPDF(file);
        });

        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const typedArray = new Uint8Array(arrayBuffer);
                state.pdfDoc = await pdfjsLib.getDocument(typedArray).promise;

                document.getElementById('pdfToolbar').style.display = 'flex';
                document.getElementById('pdfPlaceholder').style.display = 'none';
                document.getElementById('pdfCanvasContainer').style.display = 'flex';
                document.getElementById('pageCount').textContent = state.pdfDoc.numPages;

                // Extract all text
                state.pdfText = '';
                for (let i = 1; i <= state.pdfDoc.numPages; i++) {
                    const page = await state.pdfDoc.getPage(i);
                    const content = await page.getTextContent();
                    state.pdfText += content.items.map(item => item.str).join(' ') + '\n\n';
                }

                state.currentPage = 1;
                renderPage(state.currentPage);
                showToast('PDF loaded successfully!', 'success');
            } catch (err) {
                console.error(err);
                showToast('Failed to load PDF: ' + err.message, 'error');
            }
        }

        async function renderPage(num) {
            if (!state.pdfDoc) return;
            const page = await state.pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: state.zoom * 1.5 });

            const container = document.getElementById('pdfCanvasContainer');
            container.innerHTML = '';

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: ctx, viewport }).promise;
            container.appendChild(canvas);

            document.getElementById('pageNum').textContent = num;
        }

        function prevPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderPage(state.currentPage);
            }
        }

        function nextPage() {
            if (state.pdfDoc && state.currentPage < state.pdfDoc.numPages) {
                state.currentPage++;
                renderPage(state.currentPage);
            }
        }

        function zoomIn() {
            state.zoom = Math.min(3, state.zoom + 0.2);
            document.getElementById('zoomLevel').textContent = Math.round(state.zoom * 100) + '%';
            renderPage(state.currentPage);
        }

        function zoomOut() {
            state.zoom = Math.max(0.3, state.zoom - 0.2);
            document.getElementById('zoomLevel').textContent = Math.round(state.zoom * 100) + '%';
            renderPage(state.currentPage);
        }

        // ===== DRAG & DROP PDF =====
        function setupDragDrop() {
            const panel = document.getElementById('pdfPanel');
            panel.addEventListener('dragover', (e) => {
                e.preventDefault();
                panel.classList.add('drop-zone-active');
            });
            panel.addEventListener('dragleave', () => {
                panel.classList.remove('drop-zone-active');
            });
            panel.addEventListener('drop', async (e) => {
                e.preventDefault();
                panel.classList.remove('drop-zone-active');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    await loadPDF(file);
                } else {
                    showToast('Please drop a PDF file', 'error');
                }
            });
        }

        // ===== TAB SWITCHING =====
        function setupTabs() {
            document.querySelectorAll('.workspace-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.workspace-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        // ===== SECTION COLLAPSE =====
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const body = header.nextElementSibling;
            body.classList.toggle('collapsed');
        }

        // ===== PHASE MANAGEMENT =====
        function setPhase(phase) {
            state.currentPhase = phase;
            document.querySelectorAll('.phase-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i < phase) el.classList.add('completed');
                if (i === phase) el.classList.add('active');
            });
            document.querySelectorAll('.phase-label').forEach((el, i) => {
                el.classList.toggle('active', i === phase);
            });
        }

        // ===== DIAGNOSES =====
        function addDiagnosis() {
            const input = document.getElementById('dxInput');
            const text = input.value.trim();
            if (!text) return;

            state.diagnoses.push({
                id: state.nextId++,
                text,
                ruledOut: false,
                confidence: 50
            });

            input.value = '';
            input.focus();
            renderDiagnoses();
        }

        function removeDiagnosis(id) {
            state.diagnoses = state.diagnoses.filter(d => d.id !== id);
            renderDiagnoses();
        }

        function toggleRuleOut(id) {
            const dx = state.diagnoses.find(d => d.id === id);
            if (dx) dx.ruledOut = !dx.ruledOut;
            renderDiagnoses();
        }

        function moveDiagnosis(id, direction) {
            const idx = state.diagnoses.findIndex(d => d.id === id);
            if (idx === -1) return;
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= state.diagnoses.length) return;
            [state.diagnoses[idx], state.diagnoses[newIdx]] = [state.diagnoses[newIdx], state.diagnoses[idx]];
            renderDiagnoses();
        }

        function renderDiagnoses() {
            const list = document.getElementById('dxList');
            const empty = document.getElementById('dxEmpty');
            const count = state.diagnoses.length;
            document.getElementById('dxCount').textContent = count;

            // Badge on workup tab too
            document.getElementById('workupCount').textContent =
                state.diagnoses.length + state.tests.length + state.management.length;

            if (count === 0) {
                list.innerHTML = '';
                list.appendChild(createEmptyState('üéØ', 'No diagnoses yet. Start building your differential!'));
                return;
            }

            list.innerHTML = '';
            state.diagnoses.forEach((dx, i) => {
                const li = document.createElement('li');
                li.className = 'dx-item' + (dx.ruledOut ? ' dx-ruled-out' : '');
                li.draggable = true;
                li.dataset.id = dx.id;

                li.addEventListener('dragstart', handleDxDragStart);
                li.addEventListener('dragover', handleDxDragOver);
                li.addEventListener('drop', handleDxDrop);
                li.addEventListener('dragend', handleDxDragEnd);

                const rankClass = i === 0 && !dx.ruledOut ? 'top' : '';
                li.innerHTML = `
                    <span class="dx-drag-handle" title="Drag to reorder">‚†ø</span>
                    <span class="dx-rank ${rankClass}">${i + 1}</span>
                    <span class="dx-text">${escapeHtml(dx.text)}</span>
                    ${dx.ruledOut ? '<span class="answer-tag incorrect">Ruled Out</span>' : ''}
                    <div class="dx-actions">
                        <button class="btn btn-ghost btn-icon" onclick="moveDiagnosis(${dx.id}, -1)" title="Move up">‚ñ≤</button>
                        <button class="btn btn-ghost btn-icon" onclick="moveDiagnosis(${dx.id}, 1)" title="Move down">‚ñº</button>
                        <button class="btn btn-ghost btn-icon" onclick="toggleRuleOut(${dx.id})" title="${dx.ruledOut ? 'Restore' : 'Rule out'}">${dx.ruledOut ? '‚ôª' : 'üö´'}</button>
                        <button class="btn btn-ghost btn-icon" onclick="removeDiagnosis(${dx.id})" title="Delete">üóë</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // Drag & drop for diagnoses
        let draggedDxId = null;

        function handleDxDragStart(e) {
            draggedDxId = parseInt(e.currentTarget.dataset.id);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDxDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const item = e.currentTarget;
            item.classList.add('drag-over');
        }

        function handleDxDrop(e) {
            e.preventDefault();
            const targetId = parseInt(e.currentTarget.dataset.id);
            if (draggedDxId === null || draggedDxId === targetId) return;

            const fromIdx = state.diagnoses.findIndex(d => d.id === draggedDxId);
            const toIdx = state.diagnoses.findIndex(d => d.id === targetId);
            if (fromIdx === -1 || toIdx === -1) return;

            const [moved] = state.diagnoses.splice(fromIdx, 1);
            state.diagnoses.splice(toIdx, 0, moved);
            renderDiagnoses();
        }

        function handleDxDragEnd(e) {
            draggedDxId = null;
            document.querySelectorAll('.dx-item').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
        }

        // ===== TESTS =====
        function addTest() {
            const input = document.getElementById('testInput');
            const category = document.getElementById('testCategory').value;
            const rationale = document.getElementById('testRationale');
            const name = input.value.trim();
            if (!name) return;

            state.tests.push({
                id: state.nextId++,
                name,
                category,
                rationale: rationale.value.trim()
            });

            input.value = '';
            rationale.value = '';
            input.focus();
            renderTests();
        }

        function removeTest(id) {
            state.tests = state.tests.filter(t => t.id !== id);
            renderTests();
        }

        function renderTests() {
            const list = document.getElementById('testList');
            const count = state.tests.length;
            document.getElementById('testCount').textContent = count;
            document.getElementById('workupCount').textContent =
                state.diagnoses.length + state.tests.length + state.management.length;

            if (count === 0) {
                list.innerHTML = '';
                list.appendChild(createEmptyState('üß™', 'No tests ordered yet.'));
                return;
            }

            list.innerHTML = '';
            const catIcons = { lab: 'üß™', imaging: 'ü©ª', procedure: 'üî¨', other: 'üìã' };

            state.tests.forEach(t => {
                const li = document.createElement('li');
                li.className = 'item-entry';
                li.innerHTML = `
                    <span class="item-icon">${catIcons[t.category] || 'üìã'}</span>
                    <div class="item-content">
                        <div class="item-name">${escapeHtml(t.name)}</div>
                        ${t.rationale ? `<div class="item-rationale">${escapeHtml(t.rationale)}</div>` : ''}
                    </div>
                    <span class="item-category cat-${t.category}">${t.category}</span>
                    <button class="btn btn-ghost btn-icon" onclick="removeTest(${t.id})" title="Remove">üóë</button>
                `;
                list.appendChild(li);
            });
        }

        // ===== MANAGEMENT =====
        function addManagement() {
            const input = document.getElementById('mgmtInput');
            const category = document.getElementById('mgmtCategory').value;
            const rationale = document.getElementById('mgmtRationale');
            const name = input.value.trim();
            if (!name) return;

            state.management.push({
                id: state.nextId++,
                name,
                category,
                rationale: rationale.value.trim()
            });

            input.value = '';
            rationale.value = '';
            input.focus();
            renderManagement();
        }

        function removeManagement(id) {
            state.management = state.management.filter(m => m.id !== id);
            renderManagement();
        }

        function renderManagement() {
            const list = document.getElementById('mgmtList');
            const count = state.management.length;
            document.getElementById('mgmtCount').textContent = count;
            document.getElementById('workupCount').textContent =
                state.diagnoses.length + state.tests.length + state.management.length;

            if (count === 0) {
                list.innerHTML = '';
                list.appendChild(createEmptyState('üíä', 'No management plans yet.'));
                return;
            }

            list.innerHTML = '';
            const catIcons = { medication: 'üíä', intervention: 'üè•', consult: 'üìû', other: 'üìã' };

            state.management.forEach(m => {
                const li = document.createElement('li');
                li.className = 'item-entry';
                li.innerHTML = `
                    <span class="item-icon">${catIcons[m.category] || 'üìã'}</span>
                    <div class="item-content">
                        <div class="item-name">${escapeHtml(m.name)}</div>
                        ${m.rationale ? `<div class="item-rationale">${escapeHtml(m.rationale)}</div>` : ''}
                    </div>
                    <span class="item-category cat-${m.category}">${m.category}</span>
                    <button class="btn btn-ghost btn-icon" onclick="removeManagement(${m.id})" title="Remove">üóë</button>
                `;
                list.appendChild(li);
            });
        }

        // ===== LLM EXTRACTION =====
        async function extractWithLLM() {
            if (!state.pdfText.trim()) {
                showToast('No PDF text found. Make sure a PDF is loaded.', 'error');
                return;
            }

            if (state.llmProvider === 'none') {
                showToast('No LLM configured. Go to Settings to set one up, or use manual answer key.', 'error');
                return;
            }

            const btn = document.getElementById('extractBtn');
            const origText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Extracting...';
            btn.disabled = true;

            try {
                const prompt = buildExtractionPrompt(state.pdfText);
                const response = await callLLM(prompt);
                const parsed = parseExtractionResponse(response);

                if (parsed) {
                    state.answerKey = parsed;
                    document.getElementById('answerDiagnosis').value = parsed.diagnosis || '';
                    document.getElementById('answerTests').value = (parsed.tests || []).join(', ');
                    document.getElementById('answerTreatments').value = (parsed.treatments || []).join(', ');
                    document.getElementById('answerDifferentials').value = (parsed.differentials || []).join(', ');
                    showToast('‚úÖ Case data extracted successfully!', 'success');
                } else {
                    showToast('Failed to parse extraction. Check console.', 'error');
                }
            } catch (err) {
                console.error('Extraction error:', err);
                showToast('Extraction failed: ' + err.message, 'error');
            } finally {
                btn.innerHTML = origText;
                btn.disabled = false;
            }
        }

        function buildExtractionPrompt(text) {
            // Truncate to ~12k chars to stay within limits
            const truncated = text.substring(0, 12000);
            return `You are a medical education assistant. Analyze the following medical case and extract key information. Return your response as valid JSON only, no markdown, no explanation.

JSON format:
{
  "diagnosis": "the final/correct diagnosis",
  "differentials": ["list", "of", "differential", "diagnoses", "considered"],
  "tests": ["list", "of", "diagnostic", "tests", "performed"],
  "treatments": ["list", "of", "treatments", "given"],
  "keyFindings": "brief summary of key clinical findings",
  "specialty": "medical specialty"
}

Case text:
${truncated}`;
        }

        async function callLLM(prompt) {
            switch (state.llmProvider) {
                case 'openai': return callOpenAI(prompt);
                case 'anthropic': return callAnthropic(prompt);
                case 'gemini': return callGemini(prompt);
                case 'ollama': return callOllama(prompt);
                case 'openrouter': return callOpenRouter(prompt);
                default: throw new Error('No LLM provider configured');
            }
        }

        async function callOpenAI(prompt) {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.2,
                    max_tokens: 2000
                })
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `OpenAI API error: ${res.status}`);
            }
            const data = await res.json();
            return data.choices[0].message.content;
        }

        async function callAnthropic(prompt) {
            // Note: Anthropic API has CORS restrictions, may need a proxy for browser-only usage
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-3-haiku-20240307',
                    max_tokens: 2000,
                    messages: [{ role: 'user', content: prompt }]
                })
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `Anthropic API error: ${res.status}`);
            }
            const data = await res.json();
            return data.content[0].text;
        }

        async function callGemini(prompt) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.2, maxOutputTokens: 2000 }
                })
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `Gemini API error: ${res.status}`);
            }
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function callOllama(prompt) {
            const res = await fetch(`${state.ollamaUrl}/api/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: state.ollamaModel,
                    prompt: prompt,
                    stream: false,
                    options: { temperature: 0.2 }
                })
            });
            if (!res.ok) throw new Error(`Ollama error: ${res.status}`);
            const data = await res.json();
            return data.response;
        }

        async function callOpenRouter(prompt) {
            const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'CaseDx Medical Simulator'
                },
                body: JSON.stringify({
                    model: state.openrouterModel,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.2,
                    max_tokens: 2000
                })
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error?.message || `OpenRouter error: ${res.status}`);
            }
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function parseExtractionResponse(text) {
            try {
                // Try to find JSON in the response
                let jsonStr = text;

                // Remove markdown code block if present
                const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                }

                // Try to find JSON object
                const objMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (objMatch) {
                    jsonStr = objMatch[0];
                }

                const parsed = JSON.parse(jsonStr);
                return {
                    diagnosis: parsed.diagnosis || '',
                    differentials: Array.isArray(parsed.differentials) ? parsed.differentials : [],
                    tests: Array.isArray(parsed.tests) ? parsed.tests : [],
                    treatments: Array.isArray(parsed.treatments) ? parsed.treatments : [],
                    keyFindings: parsed.keyFindings || '',
                    specialty: parsed.specialty || ''
                };
            } catch (e) {
                console.error('Parse error:', e, 'Raw text:', text);
                return null;
            }
        }

        // ===== SCORING =====
        function scoreCase() {
            const diagnosis = document.getElementById('answerDiagnosis').value.trim();
            const tests = document.getElementById('answerTests').value.split(',').map(s => s.trim()).filter(Boolean);
            const treatments = document.getElementById('answerTreatments').value.split(',').map(s => s.trim()).filter(Boolean);
            const differentials = document.getElementById('answerDifferentials').value.split(',').map(s => s.trim()).filter(Boolean);

            if (!diagnosis) {
                showToast('Please enter the correct diagnosis first.', 'error');
                return;
            }

            state.answerKey = { diagnosis, tests, treatments, differentials };

            // Calculate scores
            const dxScore = calculateDiagnosisScore(diagnosis, differentials);
            const testScore = calculateListScore(state.tests.map(t => t.name), tests);
            const mgmtScore = calculateListScore(state.management.map(m => m.name), treatments);

            const overallScore = Math.round((dxScore.score + testScore.score + mgmtScore.score) / 3);

            // Render score
            const container = document.getElementById('scoreResults');
            container.style.display = 'block';
            document.getElementById('noScoreYet').style.display = 'none';

            container.innerHTML = `
                <div class="score-card">
                    <h3>Overall Performance</h3>
                    <div class="score-grid">
                        <div class="score-item">
                            <div class="score-value ${getScoreClass(dxScore.score)}">${dxScore.score}%</div>
                            <div class="score-label">Diagnosis</div>
                        </div>
                        <div class="score-item">
                            <div class="score-value ${getScoreClass(testScore.score)}">${testScore.score}%</div>
                            <div class="score-label">Testing</div>
                        </div>
                        <div class="score-item">
                            <div class="score-value ${getScoreClass(mgmtScore.score)}">${mgmtScore.score}%</div>
                            <div class="score-label">Management</div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
                        <div class="score-value ${getScoreClass(overallScore)}" style="font-size:2.5rem;">${overallScore}%</div>
                        <div class="score-label" style="font-size:0.85rem;">Overall Score</div>
                    </div>
                </div>

                <!-- Diagnosis Detail -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üéØ Diagnosis Breakdown</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <p style="margin-bottom:8px;"><strong>Correct Diagnosis:</strong> ${escapeHtml(diagnosis)}</p>
                        <p style="margin-bottom:12px; font-size:0.85rem; color:var(--gray-500);">${dxScore.detail}</p>
                        ${state.diagnoses.length > 0 ? `
                            <table class="comparison-table">
                                <tr><th>#</th><th>Your Differential</th><th>Status</th></tr>
                                ${state.diagnoses.map((d, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td class="${d.ruledOut ? 'match-no' : ''}">${escapeHtml(d.text)}${d.ruledOut ? ' (ruled out)' : ''}</td>
                                        <td>${getDxMatchTag(d.text, diagnosis, differentials)}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        ` : '<p style="color:var(--gray-400);">No diagnoses were entered.</p>'}
                    </div>
                </div>

                <!-- Testing Detail -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üß™ Testing Breakdown</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-body">
                        ${renderComparisonList('Your Tests', state.tests.map(t=>t.name), 'Answer Key Tests', tests)}
                    </div>
                </div>

                <!-- Management Detail -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üíä Management Breakdown</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-body">
                        ${renderComparisonList('Your Treatments', state.management.map(m=>m.name), 'Answer Key Treatments', treatments)}
                    </div>
                </div>

                <button class="btn btn-outline" onclick="document.getElementById('scoreResults').style.display='none'; document.getElementById('noScoreYet').style.display='block';" style="width:100%; margin-top:8px;">
                    ‚Üê Edit Answer Key
                </button>
            `;
        }

        function calculateDiagnosisScore(correctDx, differentials) {
            if (state.diagnoses.length === 0) {
                return { score: 0, detail: 'No diagnoses entered.' };
            }

            const activeDx = state.diagnoses.filter(d => !d.ruledOut);
            if (activeDx.length === 0) {
                return { score: 0, detail: 'All diagnoses were ruled out.' };
            }

            // Check if #1 active diagnosis matches
            const topDx = activeDx[0].text.toLowerCase();
            const correct = correctDx.toLowerCase();

            if (fuzzyMatch(topDx, correct)) {
                return { score: 100, detail: `Your #1 diagnosis "${activeDx[0].text}" matches the correct diagnosis!` };
            }

            // Check if correct dx is anywhere in active list
            const matchIdx = activeDx.findIndex(d => fuzzyMatch(d.text.toLowerCase(), correct));
            if (matchIdx > 0) {
                const penalty = matchIdx * 15;
                const score = Math.max(20, 85 - penalty);
                return { score, detail: `Correct diagnosis was #${matchIdx + 1} on your active list. Higher ranking = better score.` };
            }

            // Check if any differentials match
            const diffMatches = activeDx.filter(d =>
                differentials.some(diff => fuzzyMatch(d.text.toLowerCase(), diff.toLowerCase()))
            ).length;

            if (diffMatches > 0) {
                return { score: Math.min(40, diffMatches * 15), detail: `${diffMatches} of your diagnoses were on the differential list, but you didn't identify the correct final diagnosis.` };
            }

            return { score: 0, detail: 'The correct diagnosis was not on your differential.' };
        }

        function calculateListScore(userItems, answerItems) {
            if (answerItems.length === 0) return { score: 100, detail: '' };
            if (userItems.length === 0) return { score: 0, detail: 'No items entered.' };

            let matches = 0;
            answerItems.forEach(answer => {
                if (userItems.some(u => fuzzyMatch(u.toLowerCase(), answer.toLowerCase()))) {
                    matches++;
                }
            });

            const score = Math.round((matches / answerItems.length) * 100);
            return { score, detail: `${matches}/${answerItems.length} key items matched.` };
        }

        function fuzzyMatch(a, b) {
            a = a.toLowerCase().replace(/[^a-z0-9]/g, '');
            b = b.toLowerCase().replace(/[^a-z0-9]/g, '');

            if (a === b) return true;
            if (a.includes(b) || b.includes(a)) return true;

            // Simple word overlap check
            const wordsA = a.replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 2);
            const wordsB = b.replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 2);
            if (wordsA.length === 0 || wordsB.length === 0) return false;

            const overlap = wordsA.filter(w => wordsB.some(wb => wb.includes(w) || w.includes(wb)));
            return overlap.length >= Math.min(2, Math.ceil(wordsB.length * 0.6));
        }

        function getDxMatchTag(userDx, correctDx, differentials) {
            const u = userDx.toLowerCase();
            if (fuzzyMatch(u, correctDx.toLowerCase())) {
                return '<span class="answer-tag correct">‚úì Correct Dx</span>';
            }
            if (differentials.some(d => fuzzyMatch(u, d.toLowerCase()))) {
                return '<span class="answer-tag partial">~ On Differential</span>';
            }
            return '<span class="answer-tag incorrect">‚úó Not matched</span>';
        }

        function renderComparisonList(userLabel, userItems, answerLabel, answerItems) {
            let html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">';

            html += `<div><h4 style="font-size:0.85rem; margin-bottom:8px; color:var(--gray-600);">${userLabel}</h4>`;
            if (userItems.length === 0) {
                html += '<p style="color:var(--gray-400); font-size:0.85rem;">None entered</p>';
            } else {
                userItems.forEach(item => {
                    const matched = answerItems.some(a => fuzzyMatch(item.toLowerCase(), a.toLowerCase()));
                    html += `<div style="padding:4px 0; font-size:0.85rem;">
                        ${matched ? '<span class="match-yes">‚úì</span>' : '<span class="match-no">‚óã</span>'}
                        ${escapeHtml(item)}
                    </div>`;
                });
            }
            html += '</div>';

            html += `<div><h4 style="font-size:0.85rem; margin-bottom:8px; color:var(--gray-600);">${answerLabel}</h4>`;
            if (answerItems.length === 0) {
                html += '<p style="color:var(--gray-400); font-size:0.85rem;">None specified</p>';
            } else {
                answerItems.forEach(item => {
                    const matched = userItems.some(u => fuzzyMatch(u.toLowerCase(), item.toLowerCase()));
                    html += `<div style="padding:4px 0; font-size:0.85rem;">
                        ${matched ? '<span class="match-yes">‚úì</span>' : '<span class="match-no">‚úó</span>'}
                        ${escapeHtml(item)}
                    </div>`;
                });
            }
            html += '</div></div>';

            return html;
        }

        function getScoreClass(score) {
            if (score >= 70) return 'good';
            if (score >= 40) return 'okay';
            return 'poor';
        }

        // ===== SETTINGS =====
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            // Restore current values
            const radios = document.querySelectorAll('input[name="llmProvider"]');
            radios.forEach(r => { r.checked = r.value === state.llmProvider; });
            document.getElementById('apiKeyInput').value = state.apiKey;
            document.getElementById('ollamaUrl').value = state.ollamaUrl;
            document.getElementById('ollamaModel').value = state.ollamaModel;
            document.getElementById('openrouterModel').value = state.openrouterModel;
            updateSettingsVisibility();

            // Listen for radio changes
            radios.forEach(r => r.addEventListener('change', updateSettingsVisibility));
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function updateSettingsVisibility() {
            const provider = document.querySelector('input[name="llmProvider"]:checked').value;
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const ollamaGroup = document.getElementById('ollamaGroup');
            const openrouterGroup = document.getElementById('openrouterGroup');

            apiKeyGroup.style.display = ['openai', 'anthropic', 'gemini', 'openrouter'].includes(provider) ? 'block' : 'none';
            ollamaGroup.style.display = provider === 'ollama' ? 'block' : 'none';
            openrouterGroup.style.display = provider === 'openrouter' ? 'block' : 'none';
        }

        function saveSettings() {
            state.llmProvider = document.querySelector('input[name="llmProvider"]:checked').value;
            state.apiKey = document.getElementById('apiKeyInput').value.trim();
            state.ollamaUrl = document.getElementById('ollamaUrl').value.trim();
            state.ollamaModel = document.getElementById('ollamaModel').value.trim();
            state.openrouterModel = document.getElementById('openrouterModel').value.trim();

            // Save to localStorage
            localStorage.setItem('casedx_settings', JSON.stringify({
                llmProvider: state.llmProvider,
                apiKey: state.apiKey,
                ollamaUrl: state.ollamaUrl,
                ollamaModel: state.ollamaModel,
                openrouterModel: state.openrouterModel
            }));

            updateLLMStatus();
            closeSettings();
            showToast('Settings saved!', 'success');
        }

        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem('casedx_settings'));
                if (saved) {
                    state.llmProvider = saved.llmProvider || 'none';
                    state.apiKey = saved.apiKey || '';
                    state.ollamaUrl = saved.ollamaUrl || 'http://localhost:11434';
                    state.ollamaModel = saved.ollamaModel || 'llama3.2';
                    state.openrouterModel = saved.openrouterModel || 'meta-llama/llama-3.1-8b-instruct:free';
                }
            } catch (e) {}
        }

        function updateLLMStatus() {
            const dot = document.getElementById('llmDot');
            const name = document.getElementById('llmName');

            const names = {
                none: 'Manual Mode',
                openai: 'OpenAI',
                anthropic: 'Anthropic',
                gemini: 'Gemini',
                ollama: 'Ollama',
                openrouter: 'OpenRouter'
            };

            name.textContent = names[state.llmProvider] || 'None';

            if (state.llmProvider === 'none') {
                dot.className = 'llm-dot';
            } else if (state.llmProvider === 'ollama' || state.apiKey) {
                dot.className = 'llm-dot connected';
            } else {
                dot.className = 'llm-dot error';
            }
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // ===== RESIZE HANDLE =====
        function setupResize() {
            const handle = document.getElementById('resizeHandle');
            const panel = document.getElementById('workspacePanel');
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                handle.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const containerRect = document.querySelector('.main-container').getBoundingClientRect();
                const newWidth = containerRect.right - e.clientX;
                const clamped = Math.max(380, Math.min(800, newWidth));
                panel.style.width = clamped + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    handle.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // ===== RESET =====
        function resetCase() {
            if (state.diagnoses.length + state.tests.length + state.management.length > 0) {
                if (!confirm('Are you sure you want to reset? All your entries will be cleared.')) return;
            }

            state.pdfDoc = null;
            state.currentPage = 1;
            state.zoom = 1.0;
            state.pdfText = '';
            state.diagnoses = [];
            state.tests = [];
            state.management = [];
            state.currentPhase = 0;
            state.answerKey = null;
            state.nextId = 1;

            // Reset PDF viewer
            document.getElementById('pdfToolbar').style.display = 'none';
            document.getElementById('pdfPlaceholder').style.display = 'flex';
            document.getElementById('pdfCanvasContainer').style.display = 'none';
            document.getElementById('pdfCanvasContainer').innerHTML = '';
            document.getElementById('zoomLevel').textContent = '100%';

            // Reset workspace
            document.getElementById('hpiNotes').value = '';
            document.getElementById('examNotes').value = '';
            document.getElementById('generalNotes').value = '';
            document.getElementById('answerDiagnosis').value = '';
            document.getElementById('answerTests').value = '';
            document.getElementById('answerTreatments').value = '';
            document.getElementById('answerDifferentials').value = '';
            document.getElementById('scoreResults').style.display = 'none';
            document.getElementById('scoreResults').innerHTML = '';
            document.getElementById('noScoreYet').style.display = 'block';

            setPhase(0);
            renderDiagnoses();
            renderTests();
            renderManagement();

            // Switch to first tab
            document.querySelectorAll('.workspace-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelector('.workspace-tab').classList.add('active');
            document.getElementById('tab-workup').classList.add('active');

            // Reset file input
            document.getElementById('pdfInput').value = '';

            showToast('Case reset!', 'info');
        }

        // ===== UTILITIES =====
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function createEmptyState(icon, message) {
            const li = document.createElement('li');
            li.className = 'empty-state';
            li.innerHTML = `<div class="empty-icon">${icon}</div><p>${message}</p>`;
            return li;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>