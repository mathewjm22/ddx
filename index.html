<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Case Review | Differential Diagnosis Builder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #2d3748;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: #fff;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 12px rgba(0,0,0,.25);
            z-index: 100;
            flex-shrink: 0;
        }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-brand .logo { font-size: 1.6rem; }
        .header-brand h1 { font-size: 1.15rem; font-weight: 700; letter-spacing: .3px; }
        .header-brand .subtitle { font-size: .75rem; font-weight: 400; opacity: .75; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .btn {
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: .82rem;
            font-weight: 600;
            transition: all .2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-upload { background: #48bb78; color: #fff; }
        .btn-upload:hover { background: #38a169; transform: translateY(-1px); }
        .btn-reset { background: rgba(255,255,255,.12); color: #fff; border: 1px solid rgba(255,255,255,.25); }
        .btn-reset:hover { background: rgba(255,255,255,.22); }
        .btn-save { background: #4299e1; color: #fff; }
        .btn-save:hover { background: #3182ce; transform: translateY(-1px); }
        #file-input { display: none; }

        /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* â”€â”€ PDF Panel (Left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pdf-panel {
            width: 55%;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            background: #1e2533;
            flex-shrink: 0;
        }

        .pdf-toolbar {
            background: #2d3748;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 1px solid #4a5568;
            flex-shrink: 0;
        }
        .pdf-toolbar button {
            background: rgba(255,255,255,.08);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,.15);
            padding: 5px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: .8rem;
            transition: all .15s;
        }
        .pdf-toolbar button:hover:not(:disabled) { background: rgba(255,255,255,.18); }
        .pdf-toolbar button:disabled { opacity: .35; cursor: default; }
        .pdf-toolbar .page-info { color: #a0aec0; font-size: .8rem; min-width: 90px; text-align: center; }
        .pdf-toolbar .sep { width: 1px; height: 18px; background: rgba(255,255,255,.2); margin: 0 4px; }

        .pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .pdf-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #718096;
            height: 100%;
            width: 100%;
            text-align: center;
            user-select: none;
        }
        .pdf-placeholder .ph-icon { font-size: 4.5rem; margin-bottom: 18px; opacity: .6; }
        .pdf-placeholder .ph-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 6px; }
        .pdf-placeholder .ph-sub { font-size: .85rem; opacity: .7; }

        #pdf-container {
            position: relative;
            display: none;
            line-height: 0;
        }
        #pdf-canvas {
            display: block;
            box-shadow: 0 4px 24px rgba(0,0,0,.5);
            border-radius: 2px;
        }

        /* â”€â”€ PDF Text Layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #text-layer {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden;
            line-height: 1.0;
        }
        #text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
        #text-layer ::selection { background: rgba(66, 153, 225, .45); color: transparent; }
        #text-layer ::-moz-selection { background: rgba(66, 153, 225, .45); color: transparent; }

        /* â”€â”€ Resizer Handle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background: #2c5282;
            flex-shrink: 0;
            transition: background .2s;
            position: relative;
            z-index: 10;
        }
        .resizer:hover, .resizer.active { background: #4299e1; }

        /* â”€â”€ Diagnostic Panel (Right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .diagnostic-panel {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            min-width: 320px;
        }

        .panel-inner {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Case Title */
        .case-title-bar {
            background: #fff;
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,.06);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .case-title-bar label { font-weight: 600; font-size: .82rem; color: #4a5568; white-space: nowrap; }
        .case-title-bar input {
            flex: 1; border: none; outline: none;
            font-family: inherit; font-size: .92rem; font-weight: 500;
            color: #1a365d; background: transparent;
        }
        .case-title-bar input::placeholder { color: #a0aec0; font-weight: 400; }

        /* Grid for middle two boxes */
        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media (max-width: 1100px) {
            .two-col-grid { grid-template-columns: 1fr; }
        }

        /* â”€â”€ Diagnostic Box (Generic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dx-box {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 6px rgba(0,0,0,.07);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: box-shadow .2s;
            flex-shrink: 0;         /* KEY FIX: never compress */
        }
        .dx-box:hover { box-shadow: 0 3px 12px rgba(0,0,0,.1); }

        .dx-box-header {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            font-size: .78rem;
            letter-spacing: .6px;
            text-transform: uppercase;
            color: #fff;
            flex-shrink: 0;
        }
        .dx-box-header .badge {
            background: rgba(255,255,255,.25);
            padding: 1px 10px;
            border-radius: 10px;
            font-size: .75rem;
            font-weight: 600;
        }

        /* Color Themes */
        .theme-red   .dx-box-header { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .theme-blue  .dx-box-header { background: linear-gradient(135deg, #3182ce, #2b6cb0); }
        .theme-green .dx-box-header { background: linear-gradient(135deg, #38a169, #2f855a); }
        .theme-purple .dx-box-header { background: linear-gradient(135deg, #805ad5, #6b46c1); }

        .theme-red   .dx-add-btn { background: #e53e3e; }
        .theme-red   .dx-add-btn:hover { background: #c53030; }
        .theme-blue  .dx-add-btn { background: #3182ce; }
        .theme-blue  .dx-add-btn:hover { background: #2b6cb0; }
        .theme-green .dx-add-btn { background: #38a169; }
        .theme-green .dx-add-btn:hover { background: #2f855a; }
        .theme-purple .dx-add-btn { background: #805ad5; }
        .theme-purple .dx-add-btn:hover { background: #6b46c1; }

        .theme-red   .rank-num { background: #e53e3e; }
        .theme-blue  .rank-num { background: #3182ce; }
        .theme-green .rank-num { background: #38a169; }
        .theme-purple .rank-num { background: #805ad5; }

        /* Subheader hint */
        .dx-hint {
            padding: 5px 16px;
            font-size: .72rem;
            color: #e53e3e;
            background: #fff5f5;
            border-bottom: 1px solid #fed7d7;
            text-align: center;
            font-weight: 500;
            flex-shrink: 0;
        }

        /* Input area */
        .dx-input-row {
            padding: 10px 12px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #edf2f7;
            flex-shrink: 0;
        }
        .dx-input-row input {
            flex: 1;
            padding: 7px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            font-size: .85rem;
            outline: none;
            transition: border-color .2s;
        }
        .dx-input-row input:focus { border-color: #4299e1; }
        .dx-add-btn {
            padding: 7px 16px;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: .82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
            white-space: nowrap;
        }

        /* List area â€” NO max-height; grows naturally, panel scrolls */
        .dx-list {
            padding: 6px 8px;
            min-height: 48px;
        }

        .dx-list-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 48px;
            color: #a0aec0;
            font-size: .82rem;
            font-style: italic;
            user-select: none;
        }

        /* List Item */
        .dx-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            margin: 3px 0;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 7px;
            transition: all .15s;
            user-select: none;
            animation: fadeSlideIn .2s ease;
        }
        .dx-item:hover { background: #edf2f7; border-color: #cbd5e0; }
        .dx-item.dragging { opacity: .4; background: #ebf8ff; }
        .dx-item.drag-over-top { border-top: 3px solid #4299e1; padding-top: 4px; }
        .dx-item.drag-over-bottom { border-bottom: 3px solid #4299e1; padding-bottom: 4px; }

        .drag-handle {
            cursor: grab;
            color: #a0aec0;
            font-size: 1rem;
            line-height: 1;
            padding: 2px;
        }
        .drag-handle:active { cursor: grabbing; }

        .rank-num {
            width: 22px; height: 22px;
            border-radius: 50%;
            color: #fff;
            font-size: .7rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .item-text {
            flex: 1;
            font-size: .88rem;
            color: #2d3748;
            line-height: 1.3;
        }

        .item-remove {
            background: none; border: none;
            color: #cbd5e0;
            cursor: pointer;
            font-size: .95rem;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all .15s;
            display: flex; align-items: center;
            line-height: 1;
        }
        .item-remove:hover { color: #e53e3e; background: #fff5f5; }

        .item-icon { font-size: .9rem; flex-shrink: 0; }

        /* â”€â”€ Scrollbar Styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pdf-viewer::-webkit-scrollbar,
        .diagnostic-panel::-webkit-scrollbar {
            width: 7px; height: 7px;
        }
        .pdf-viewer::-webkit-scrollbar-track,
        .diagnostic-panel::-webkit-scrollbar-track { background: transparent; }
        .pdf-viewer::-webkit-scrollbar-thumb { background: rgba(255,255,255,.2); border-radius: 4px; }
        .diagnostic-panel::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .diagnostic-panel::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(-6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ Collapse / Expand toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .collapse-btn {
            background: none; border: none;
            color: rgba(255,255,255,.7);
            cursor: pointer;
            font-size: .85rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all .15s;
            margin-left: 8px;
        }
        .collapse-btn:hover { color: #fff; background: rgba(255,255,255,.15); }
        .dx-box-header-left { display: flex; align-items: center; gap: 4px; }

        .dx-body { overflow: hidden; transition: max-height .3s ease; }
        .dx-body.collapsed { max-height: 0 !important; }

        /* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media print {
            .pdf-panel, .resizer, .header-actions, .dx-input-row, .dx-hint,
            .item-remove, .drag-handle, .collapse-btn { display: none !important; }
            .main-container { display: block !important; }
            .diagnostic-panel { width: 100% !important; overflow: visible !important; }
            .dx-box { break-inside: avoid; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header">
    <div class="header-brand">
        <span class="logo">ğŸ©º</span>
        <div>
            <h1>Clinical Case Review</h1>
            <div class="subtitle">Differential Diagnosis Builder</div>
        </div>
    </div>
    <div class="header-actions">
        <input type="file" id="file-input" accept=".pdf">
        <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">
            ğŸ“„ Upload PDF
        </button>
        <button class="btn btn-save" onclick="exportSession()" title="Export session as JSON">
            ğŸ’¾ Export
        </button>
        <button class="btn btn-reset" onclick="clearAll()">
            ğŸ—‘ï¸ Reset
        </button>
    </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-container">

    <!-- â”€â”€ Left: PDF Viewer â”€â”€ -->
    <section class="pdf-panel" id="pdf-panel">
        <div class="pdf-toolbar" id="pdf-toolbar" style="display:none">
            <button id="prev-btn" onclick="changePage(-1)" disabled>â—€ Prev</button>
            <span class="page-info" id="page-info">1 / 1</span>
            <button id="next-btn" onclick="changePage(1)" disabled>Next â–¶</button>
            <span class="sep"></span>
            <button onclick="adjustZoom(-.2)">âˆ’</button>
            <span class="page-info" id="zoom-info">100%</span>
            <button onclick="adjustZoom(.2)">+</button>
            <button onclick="fitToWidth()">Fit</button>
        </div>
        <div class="pdf-viewer" id="pdf-viewer">
            <div class="pdf-placeholder" id="pdf-placeholder">
                <div class="ph-icon">ğŸ“‹</div>
                <div class="ph-title">Upload an NEJM Case PDF</div>
                <div class="ph-sub">Click <strong>Upload PDF</strong> above to begin</div>
            </div>
            <div id="pdf-container">
                <canvas id="pdf-canvas"></canvas>
                <div id="text-layer"></div>
            </div>
        </div>
    </section>

    <!-- â”€â”€ Resizer â”€â”€ -->
    <div class="resizer" id="resizer"></div>

    <!-- â”€â”€ Right: Diagnostic Grid â”€â”€ -->
    <section class="diagnostic-panel" id="diag-panel">
        <div class="panel-inner">

            <!-- Case Title -->
            <div class="case-title-bar">
                <label>ğŸ“ Case:</label>
                <input type="text" id="case-title" placeholder="e.g. NEJM CPC â€” 45 y/o F with dyspnea and rash">
            </div>

            <!-- 1. Differential Diagnosis (full-width, draggable) -->
            <div class="dx-box theme-red" id="box-ddx">
                <div class="dx-box-header">
                    <div class="dx-box-header-left">
                        <span>ğŸ” Differential Diagnosis</span>
                        <button class="collapse-btn" onclick="toggleCollapse('ddx', this)" title="Collapse / Expand">â–¼</button>
                    </div>
                    <span class="badge" id="count-ddx">0</span>
                </div>
                <div class="dx-body" id="body-ddx">
                    <div class="dx-hint">Drag & drop to rank â€” #1 = most likely</div>
                    <div class="dx-input-row">
                        <input id="input-ddx" placeholder="Add a diagnosisâ€¦"
                               onkeydown="if(event.key==='Enter')addItem('ddx')">
                        <button class="dx-add-btn" onclick="addItem('ddx')">+ Add</button>
                    </div>
                    <div class="dx-list" id="list-ddx">
                        <div class="dx-list-empty">No diagnoses yet</div>
                    </div>
                </div>
            </div>

            <!-- 2 + 3. Labs & Imaging (side by side) -->
            <div class="two-col-grid">

                <!-- Labs -->
                <div class="dx-box theme-blue" id="box-labs">
                    <div class="dx-box-header">
                        <div class="dx-box-header-left">
                            <span>ğŸ§ª Laboratory Studies</span>
                            <button class="collapse-btn" onclick="toggleCollapse('labs', this)" title="Collapse / Expand">â–¼</button>
                        </div>
                        <span class="badge" id="count-labs">0</span>
                    </div>
                    <div class="dx-body" id="body-labs">
                        <div class="dx-input-row">
                            <input id="input-labs" placeholder="Add a labâ€¦"
                                   onkeydown="if(event.key==='Enter')addItem('labs')">
                            <button class="dx-add-btn" onclick="addItem('labs')">+ Add</button>
                        </div>
                        <div class="dx-list" id="list-labs">
                            <div class="dx-list-empty">No labs yet</div>
                        </div>
                    </div>
                </div>

                <!-- Imaging -->
                <div class="dx-box theme-green" id="box-imaging">
                    <div class="dx-box-header">
                        <div class="dx-box-header-left">
                            <span>ğŸ“· Diagnostic Imaging</span>
                            <button class="collapse-btn" onclick="toggleCollapse('imaging', this)" title="Collapse / Expand">â–¼</button>
                        </div>
                        <span class="badge" id="count-imaging">0</span>
                    </div>
                    <div class="dx-body" id="body-imaging">
                        <div class="dx-input-row">
                            <input id="input-imaging" placeholder="Add imagingâ€¦"
                                   onkeydown="if(event.key==='Enter')addItem('imaging')">
                            <button class="dx-add-btn" onclick="addItem('imaging')">+ Add</button>
                        </div>
                        <div class="dx-list" id="list-imaging">
                            <div class="dx-list-empty">No imaging yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Management (full-width) -->
            <div class="dx-box theme-purple" id="box-mgmt">
                <div class="dx-box-header">
                    <div class="dx-box-header-left">
                        <span>ğŸ’Š Management Plan</span>
                        <button class="collapse-btn" onclick="toggleCollapse('mgmt', this)" title="Collapse / Expand">â–¼</button>
                    </div>
                    <span class="badge" id="count-mgmt">0</span>
                </div>
                <div class="dx-body" id="body-mgmt">
                    <div class="dx-input-row">
                        <input id="input-mgmt" placeholder="Add management considerationâ€¦"
                               onkeydown="if(event.key==='Enter')addItem('mgmt')">
                        <button class="dx-add-btn" onclick="addItem('mgmt')">+ Add</button>
                    </div>
                    <div class="dx-list" id="list-mgmt">
                        <div class="dx-list-empty">No items yet</div>
                    </div>
                </div>
            </div>

        </div><!-- /panel-inner -->
    </section>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF.js Setup
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let pdfDoc  = null,
    pageNum  = 1,
    numPages = 0,
    scale    = 1.5;

const canvas      = document.getElementById('pdf-canvas');
const ctx         = canvas.getContext('2d');
const viewer      = document.getElementById('pdf-viewer');
const container   = document.getElementById('pdf-container');
const textLayer   = document.getElementById('text-layer');
const placeholder = document.getElementById('pdf-placeholder');

/* â”€â”€ File Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('file-input').addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;
    const data = new Uint8Array(await file.arrayBuffer());
    pdfDoc = await pdfjsLib.getDocument({ data }).promise;
    numPages = pdfDoc.numPages;
    pageNum = 1;
    placeholder.style.display = 'none';
    container.style.display = 'block';
    document.getElementById('pdf-toolbar').style.display = 'flex';
    renderPage();
});

/* â”€â”€ Render Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderPage() {
    const page = await pdfDoc.getPage(pageNum);
    const vp   = page.getViewport({ scale });

    canvas.width  = vp.width;
    canvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;

    textLayer.innerHTML = '';
    textLayer.style.width  = vp.width  + 'px';
    textLayer.style.height = vp.height + 'px';

    try {
        const tc = await page.getTextContent();
        if (pdfjsLib.renderTextLayer) {
            const task = pdfjsLib.renderTextLayer({
                textContent : tc,
                container   : textLayer,
                viewport    : vp,
                textDivs    : []
            });
            if (task && task.promise) await task.promise;
        }
    } catch (err) { console.warn('Text layer error:', err); }

    document.getElementById('page-info').textContent = `${pageNum} / ${numPages}`;
    document.getElementById('prev-btn').disabled = pageNum <= 1;
    document.getElementById('next-btn').disabled = pageNum >= numPages;
    document.getElementById('zoom-info').textContent = Math.round(scale * 100) + '%';
}

function changePage(delta) {
    const p = pageNum + delta;
    if (p >= 1 && p <= numPages) { pageNum = p; renderPage(); }
}

function adjustZoom(delta) {
    scale = Math.min(4, Math.max(.4, scale + delta));
    if (pdfDoc) renderPage();
}

function fitToWidth() {
    if (!pdfDoc) return;
    pdfDoc.getPage(pageNum).then(page => {
        const unscaled = page.getViewport({ scale: 1 });
        scale = (viewer.clientWidth - 44) / unscaled.width;
        renderPage();
    });
}

document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key === 'ArrowLeft')  changePage(-1);
    if (e.key === 'ArrowRight') changePage(1);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Resizable Panel Divider
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(() => {
    const resizer  = document.getElementById('resizer');
    const pdfPanel = document.getElementById('pdf-panel');
    let startX, startW;

    resizer.addEventListener('mousedown', e => {
        startX = e.clientX;
        startW = pdfPanel.getBoundingClientRect().width;
        resizer.classList.add('active');
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        e.preventDefault();
    });
    function onMove(e) {
        const w = startW + (e.clientX - startX);
        const min = 280, max = window.innerWidth - 340;
        pdfPanel.style.width = Math.min(max, Math.max(min, w)) + 'px';
    }
    function onUp() {
        resizer.classList.remove('active');
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
    }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Collapse / Expand Toggle
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleCollapse(cat, btn) {
    const body = document.getElementById('body-' + cat);
    const isCollapsed = body.classList.toggle('collapsed');
    btn.textContent = isCollapsed ? 'â–¶' : 'â–¼';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Diagnostic Lists â€” Data & Rendering
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const lists = { ddx: [], labs: [], imaging: [], mgmt: [] };
const icons = { labs: 'ğŸ§ª', imaging: 'ğŸ“·', mgmt: 'ğŸ’Š' };

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function addItem(cat) {
    const inp = document.getElementById('input-' + cat);
    const val = inp.value.trim();
    if (!val) return;
    lists[cat].push(val);
    inp.value = '';
    renderList(cat);
    inp.focus();

    // auto-expand if collapsed
    const body = document.getElementById('body-' + cat);
    if (body.classList.contains('collapsed')) {
        body.classList.remove('collapsed');
        const btn = body.closest('.dx-box').querySelector('.collapse-btn');
        if (btn) btn.textContent = 'â–¼';
    }
}

function removeItem(cat, idx) {
    lists[cat].splice(idx, 1);
    renderList(cat);
}

function renderList(cat) {
    const el    = document.getElementById('list-' + cat);
    const count = document.getElementById('count-' + cat);
    count.textContent = lists[cat].length;

    if (lists[cat].length === 0) {
        el.innerHTML = '<div class="dx-list-empty">No items yet</div>';
        return;
    }

    el.innerHTML = '';
    lists[cat].forEach((text, i) => {
        const item = document.createElement('div');
        item.className = 'dx-item';
        item.dataset.index = i;

        if (cat === 'ddx') {
            item.draggable = true;
            item.innerHTML = `
                <span class="drag-handle" title="Drag to reorder">â ¿</span>
                <span class="rank-num">${i + 1}</span>
                <span class="item-text">${esc(text)}</span>
                <button class="item-remove" title="Remove" onclick="removeItem('ddx',${i})">âœ•</button>`;
            item.addEventListener('dragstart', onDragStart);
            item.addEventListener('dragend',   onDragEnd);
            item.addEventListener('dragover',  onDragOver);
            item.addEventListener('dragenter', onDragEnter);
            item.addEventListener('dragleave', onDragLeave);
            item.addEventListener('drop',      onDrop);
            item.addEventListener('touchstart', onTouchStart, { passive: false });
        } else {
            item.innerHTML = `
                <span class="item-icon">${icons[cat]}</span>
                <span class="item-text">${esc(text)}</span>
                <button class="item-remove" title="Remove" onclick="removeItem('${cat}',${i})">âœ•</button>`;
        }
        el.appendChild(item);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Drag-and-Drop for DDx
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let dragSrcIdx = null;

function onDragStart(e) {
    dragSrcIdx = +this.dataset.index;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', dragSrcIdx);
}
function onDragEnd() {
    this.classList.remove('dragging');
    document.querySelectorAll('.dx-item').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
    });
}
function onDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const rect = this.getBoundingClientRect();
    const mid  = rect.top + rect.height / 2;
    this.classList.toggle('drag-over-top',    e.clientY < mid);
    this.classList.toggle('drag-over-bottom', e.clientY >= mid);
}
function onDragEnter(e) { e.preventDefault(); }
function onDragLeave() {
    this.classList.remove('drag-over-top', 'drag-over-bottom');
}
function onDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    const from = dragSrcIdx;
    const to   = +this.dataset.index;
    if (from !== null && from !== to) {
        const rect = this.getBoundingClientRect();
        const before = e.clientY < rect.top + rect.height / 2;
        const moved  = lists.ddx.splice(from, 1)[0];
        let insertAt = before ? to : to + 1;
        if (from < to) insertAt--;
        if (insertAt < 0) insertAt = 0;
        if (insertAt > lists.ddx.length) insertAt = lists.ddx.length;
        lists.ddx.splice(insertAt, 0, moved);
        renderList('ddx');
    }
    this.classList.remove('drag-over-top', 'drag-over-bottom');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Touch-based Reorder
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let touchSrcIdx = null, touchClone = null, touchTarget = null;

function onTouchStart(e) {
    if (e.target.classList.contains('item-remove')) return;
    const touch = e.touches[0];
    touchSrcIdx = +this.dataset.index;
    const self = this;

    touchClone = this.cloneNode(true);
    touchClone.style.cssText = `
        position:fixed; left:${touch.clientX - 30}px; top:${touch.clientY - 20}px;
        width:${this.offsetWidth}px; opacity:.85; z-index:9999;
        pointer-events:none; box-shadow:0 8px 24px rgba(0,0,0,.25);
        border-radius:7px; background:#fff;`;
    document.body.appendChild(touchClone);
    self.classList.add('dragging');

    const onMove = ev => {
        ev.preventDefault();
        const t = ev.touches[0];
        touchClone.style.left = (t.clientX - 30) + 'px';
        touchClone.style.top  = (t.clientY - 20) + 'px';

        const el = document.elementFromPoint(t.clientX, t.clientY);
        const item = el && el.closest('.dx-item');
        document.querySelectorAll('.dx-item').forEach(d => d.classList.remove('drag-over-top'));
        if (item && +item.dataset.index !== touchSrcIdx) {
            item.classList.add('drag-over-top');
            touchTarget = +item.dataset.index;
        } else {
            touchTarget = null;
        }
    };

    const onEnd = () => {
        if (touchClone) { touchClone.remove(); touchClone = null; }
        self.classList.remove('dragging');
        document.querySelectorAll('.dx-item').forEach(d => d.classList.remove('drag-over-top'));

        if (touchTarget !== null && touchSrcIdx !== touchTarget) {
            const moved = lists.ddx.splice(touchSrcIdx, 1)[0];
            lists.ddx.splice(touchTarget, 0, moved);
            renderList('ddx');
        }
        touchSrcIdx = null;
        touchTarget = null;
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
    };

    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onEnd);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Export / Reset
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportSession() {
    const payload = {
        caseTitle: document.getElementById('case-title').value,
        timestamp: new Date().toISOString(),
        differentialDiagnosis: lists.ddx,
        laboratoryStudies: lists.labs,
        diagnosticImaging: lists.imaging,
        managementPlan: lists.mgmt
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = (payload.caseTitle || 'case-review').replace(/[^a-z0-9]/gi, '_') + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function clearAll() {
    if (!confirm('Clear all lists and reset the session?')) return;
    lists.ddx = []; lists.labs = []; lists.imaging = []; lists.mgmt = [];
    document.getElementById('case-title').value = '';
    ['ddx','labs','imaging','mgmt'].forEach(renderList);
    // expand all
    ['ddx','labs','imaging','mgmt'].forEach(cat => {
        const body = document.getElementById('body-' + cat);
        body.classList.remove('collapsed');
        const btn = body.closest('.dx-box').querySelector('.collapse-btn');
        if (btn) btn.textContent = 'â–¼';
    });
}
</script>
</body>
</html>
