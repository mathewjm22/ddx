<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseDx ‚Äì Medical Case Simulator</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #dbeafe;
            --success: #16a34a; --success-light: #dcfce7;
            --warning: #d97706; --warning-light: #fef3c7;
            --danger: #dc2626; --danger-light: #fee2e2;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
            --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
            --radius: 8px; --radius-lg: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; overflow: hidden; height: 100vh; }
        .app-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-md); z-index: 100; height: 52px; }
        .app-header h1 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border: none; border-radius: var(--radius); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: var(--transition); white-space: nowrap; }
        .btn-primary { background: white; color: var(--primary); }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-outline { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        .btn-ghost { background: transparent; color: var(--gray-500); padding: 5px 8px; }
        .btn-ghost:hover { background: var(--gray-100); color: var(--gray-700); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-icon { padding: 6px; min-width: 32px; justify-content: center; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .main-container { display: flex; height: calc(100vh - 52px); overflow: hidden; }
        .pdf-panel { flex: 1; display: flex; flex-direction: column; background: var(--gray-200); min-width: 300px; }
        .pdf-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--gray-800); color: white; font-size: 0.85rem; }
        .pdf-toolbar-group { display: flex; align-items: center; gap: 6px; }
        .pdf-toolbar .btn { color: white; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; font-size: 0.8rem; }
        .pdf-toolbar .btn:hover { background: rgba(255,255,255,0.2); }
        .pdf-content { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; }
        .pdf-canvas-container { display: flex; flex-direction: column; align-items: center; padding: 10px; gap: 10px; }
        .pdf-canvas-container canvas { box-shadow: var(--shadow-lg); max-width: 100%; }
        .pdf-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: var(--gray-400); text-align: center; padding: 40px; }
        .pdf-placeholder .upload-icon { font-size: 4rem; }
        .pdf-placeholder h3 { color: var(--gray-600); }
        .drop-zone-active .pdf-content { background: var(--primary-light); border: 3px dashed var(--primary); }
        .resize-handle { width: 6px; background: var(--gray-300); cursor: col-resize; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .resize-handle:hover, .resize-handle.active { background: var(--primary); }
        .resize-handle::after { content: '‚ãÆ'; color: var(--gray-500); font-size: 1.2rem; }
        .resize-handle:hover::after { color: white; }
        .workspace-panel { width: 520px; min-width: 380px; max-width: 800px; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .workspace-tabs { display: flex; background: var(--gray-50); border-bottom: 2px solid var(--gray-200); overflow-x: auto; flex-shrink: 0; }
        .workspace-tab { padding: 10px 16px; font-size: 0.82rem; font-weight: 600; color: var(--gray-500); cursor: pointer; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; background: none; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: var(--transition); }
        .workspace-tab:hover { color: var(--gray-700); background: var(--gray-100); }
        .workspace-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .workspace-tab .badge { background: var(--gray-200); color: var(--gray-600); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; font-weight: 700; }
        .workspace-tab.active .badge { background: var(--primary-light); color: var(--primary); }
        .workspace-content { flex: 1; overflow-y: auto; padding: 16px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .section-card { background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 16px; overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); cursor: pointer; user-select: none; }
        .section-header h3 { font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-header .collapse-icon { transition: transform 0.2s; font-size: 0.75rem; color: var(--gray-400); }
        .section-header.collapsed .collapse-icon { transform: rotate(-90deg); }
        .section-body { padding: 12px 14px; }
        .section-body.collapsed { display: none; }
        .input-group { display: flex; gap: 6px; margin-bottom: 10px; }
        .input-group input { flex: 1; padding: 8px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; }
        .input-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .dx-list { list-style: none; }
        .dx-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; margin-bottom: 4px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); cursor: grab; user-select: none; }
        .dx-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .dx-item.drag-over { border-top: 2px solid var(--primary); }
        .dx-rank { font-weight: 800; color: var(--primary); font-size: 0.85rem; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--primary-light); border-radius: 50%; flex-shrink: 0; }
        .dx-rank.top { background: var(--success-light); color: var(--success); }
        .dx-drag-handle { color: var(--gray-400); cursor: grab; font-size: 1rem; flex-shrink: 0; }
        .dx-text { flex: 1; font-size: 0.87rem; font-weight: 500; }
        .dx-actions { display: flex; gap: 2px; flex-shrink: 0; }
        .dx-actions .btn-icon { font-size: 0.85rem; padding: 3px; min-width: 24px; }
        .dx-ruled-out { text-decoration: line-through; opacity: 0.5; }
        .dx-ruled-out .dx-rank { background: var(--danger-light); color: var(--danger); }
        .item-list { list-style: none; }
        .item-entry { display: flex; align-items: flex-start; gap: 8px; padding: 8px 10px; margin-bottom: 4px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); }
        .item-entry .item-icon { flex-shrink: 0; margin-top: 2px; }
        .item-entry .item-content { flex: 1; }
        .item-entry .item-name { font-size: 0.87rem; font-weight: 600; }
        .item-entry .item-rationale { font-size: 0.8rem; color: var(--gray-500); margin-top: 2px; }
        .item-entry .item-category { font-size: 0.7rem; padding: 1px 8px; border-radius: 10px; font-weight: 600; flex-shrink: 0; margin-top: 2px; }
        .cat-lab { background: #ede9fe; color: #7c3aed; }
        .cat-imaging { background: #e0f2fe; color: #0284c7; }
        .cat-procedure { background: #fce7f3; color: #db2777; }
        .cat-other { background: var(--gray-100); color: var(--gray-600); }
        .cat-medication { background: #dcfce7; color: #16a34a; }
        .cat-intervention { background: #fef3c7; color: #d97706; }
        .cat-consult { background: #e0e7ff; color: #4f46e5; }
        .notes-textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; resize: vertical; }
        .notes-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .score-card { background: linear-gradient(135deg, var(--gray-800), var(--gray-900)); color: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
        .score-card h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-400); margin-bottom: 12px; }
        .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .score-item { text-align: center; }
        .score-value { font-size: 1.8rem; font-weight: 800; }
        .score-value.good { color: #4ade80; }
        .score-value.okay { color: #facc15; }
        .score-value.poor { color: #f87171; }
        .score-label { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 12px; }
        .comparison-table th { text-align: left; padding: 8px 10px; background: var(--gray-50); border-bottom: 2px solid var(--gray-200); font-weight: 700; font-size: 0.8rem; }
        .comparison-table td { padding: 8px 10px; border-bottom: 1px solid var(--gray-100); vertical-align: top; }
        .match-yes { color: var(--success); font-weight: 700; }
        .match-no { color: var(--danger); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: var(--radius-lg); width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--gray-200); }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-body { padding: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--gray-200); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: var(--gray-700); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 12px; border: 1.5px solid var(--gray-300); border-radius: var(--radius); font-size: 0.87rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .settings-group { margin-bottom: 20px; }
        .settings-group h4 { font-size: 0.85rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--gray-200); }
        .radio-group { display: flex; flex-direction: column; gap: 6px; }
        .radio-option { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border: 1.5px solid var(--gray-200); border-radius: var(--radius); cursor: pointer; }
        .radio-option:hover { border-color: var(--primary); background: var(--primary-light); }
        .radio-option input[type="radio"] { accent-color: var(--primary); }
        .radio-option .option-label { font-weight: 600; font-size: 0.87rem; }
        .radio-option .option-desc { font-size: 0.78rem; color: var(--gray-500); }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 18px; border-radius: var(--radius); color: white; font-size: 0.87rem; font-weight: 500; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; max-width: 450px; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }
        .toast-warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 30px 20px; color: var(--gray-400); }
        .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .llm-status { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; }
        .llm-status:hover { background: rgba(255,255,255,0.2); }
        .llm-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-400); }
        .llm-dot.connected { background: #4ade80; }
        .llm-dot.needs-key { background: #facc15; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
        .phase-bar { display: flex; gap: 2px; margin-bottom: 12px; }
        .phase-step { flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; cursor: pointer; }
        .phase-step.active { background: var(--primary); }
        .phase-step.completed { background: var(--success); }
        .phase-labels { display: flex; justify-content: space-between; margin-bottom: 16px; }
        .phase-label { font-size: 0.7rem; color: var(--gray-400); cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .phase-label.active { color: var(--primary); font-weight: 700; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .answer-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .answer-tag.correct { background: var(--success-light); color: var(--success); }
        .answer-tag.incorrect { background: var(--danger-light); color: var(--danger); }
        .answer-tag.partial { background: var(--warning-light); color: var(--warning); }
        .workspace-content::-webkit-scrollbar, .pdf-content::-webkit-scrollbar { width: 8px; }
        .workspace-content::-webkit-scrollbar-thumb, .pdf-content::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 4px; }
        @media (max-width: 900px) { .main-container { flex-direction: column; } .pdf-panel { height: 40vh; min-width: unset; } .workspace-panel { width: 100% !important; min-width: unset; max-width: unset; } .resize-handle { width: 100%; height: 6px; cursor: row-resize; } }
        .key-input-wrapper { position: relative; }
        .key-input-wrapper input { padding-right: 40px; }
        .key-toggle { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--gray-400); }
        .helper-text { font-size: 0.78rem; color: var(--gray-400); margin-bottom: 8px; }
        .select-small { padding: 4px 8px; font-size: 0.8rem; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white; }
        .setup-banner { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: var(--gray-900); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 0.9rem; }
        .setup-banner .setup-text { flex: 1; }
        .setup-banner .setup-text strong { display: block; }
        .setup-banner .setup-text span { font-size: 0.82rem; opacity: 0.8; }
        .debug-log { background: var(--gray-900); color: #4ade80; border-radius: var(--radius); padding: 12px; font-family: 'Courier New', monospace; font-size: 0.75rem; max-height: 250px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; word-break: break-all; }
        .debug-log .log-error { color: #f87171; }
        .debug-log .log-warn { color: #facc15; }
        .debug-log .log-info { color: #60a5fa; }
        .info-box { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 10px 12px; font-size: 0.78rem; color: var(--gray-500); margin-top: 8px; }
        .info-box a { color: var(--primary); font-weight: 600; }
        .info-box.warning { background: #fffbeb; border-color: #fbbf24; }
        .dx-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .dx-compare-card { border-radius: var(--radius); padding: 14px; text-align: center; }
        .dx-compare-card.clinical { background: var(--warning-light); border: 1.5px solid var(--warning); }
        .dx-compare-card.final { background: var(--success-light); border: 1.5px solid var(--success); }
        .dx-compare-card .dx-type { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .dx-compare-card.clinical .dx-type { color: var(--warning); }
        .dx-compare-card.final .dx-type { color: var(--success); }
        .dx-compare-card .dx-value { font-size: 0.95rem; font-weight: 700; color: var(--gray-800); }
        .parsed-section { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 8px; }
        .parsed-section-header { font-size: 0.78rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .parsed-section-header .found { color: var(--success); }
        .parsed-section-header .missing { color: var(--danger); }
        .parsed-section-body { font-size: 0.82rem; color: var(--gray-600); max-height: 80px; overflow-y: auto; }
        .diff-dx-list { list-style: none; padding: 0; }
        .diff-dx-item { padding: 4px 8px; margin: 2px 0; background: white; border: 1px solid var(--gray-200); border-radius: 4px; font-size: 0.82rem; font-weight: 500; }
        .model-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; font-weight: 600; margin-left: 4px; }
        .model-status.checking { background: var(--warning-light); color: var(--warning); }
        .model-status.available { background: var(--success-light); color: var(--success); }
        .model-status.unavailable { background: var(--danger-light); color: var(--danger); }
    </style>
</head>
<body>
    <div class="setup-banner" id="setupBanner" style="display:none;">
        <div>üîë</div>
        <div class="setup-text"><strong>API Key Required</strong><span>Enter your OpenRouter key to enable AI extraction.</span></div>
        <button class="btn btn-sm" style="background:white;color:var(--gray-900);" onclick="openSettings()">Set Up ‚Üí</button>
        <button class="btn btn-ghost btn-sm" style="color:var(--gray-700);" onclick="dismissBanner()">‚úï</button>
    </div>
    <header class="app-header">
        <h1><span>ü©∫</span> CaseDx</h1>
        <div class="header-actions">
            <div class="llm-status" onclick="openSettings()" title="Click to configure">
                <span class="llm-dot" id="llmDot"></span><span id="llmName">No LLM</span>
            </div>
            <label class="btn btn-primary" for="pdfInput" style="margin:0;cursor:pointer;">üìÑ Load PDF</label>
            <input type="file" id="pdfInput" accept=".pdf" style="display:none;">
            <button class="btn btn-secondary" onclick="openSettings()">‚öô</button>
            <button class="btn btn-secondary" onclick="resetCase()">üîÑ</button>
        </div>
    </header>
    <div class="main-container">
        <div class="pdf-panel" id="pdfPanel">
            <div class="pdf-toolbar" id="pdfToolbar" style="display:none;">
                <div class="pdf-toolbar-group"><button class="btn" onclick="prevPage()">‚óÄ</button><span>Page <span id="pageNum">1</span>/<span id="pageCount">1</span></span><button class="btn" onclick="nextPage()">‚ñ∂</button></div>
                <div class="pdf-toolbar-group"><button class="btn" onclick="zoomOut()">‚àí</button><span id="zoomLevel">100%</span><button class="btn" onclick="zoomIn()">+</button><button class="btn" onclick="extractWithLLM()" id="extractBtn">ü§ñ Extract</button></div>
            </div>
            <div class="pdf-content" id="pdfContent">
                <div class="pdf-placeholder" id="pdfPlaceholder"><div class="upload-icon">üìã</div><h3>Load a Case PDF</h3><p>Click "Load PDF" or drag & drop here.</p><label class="btn btn-outline" for="pdfInput" style="cursor:pointer;">Choose File</label></div>
                <div class="pdf-canvas-container" id="pdfCanvasContainer" style="display:none;"></div>
            </div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="workspace-panel" id="workspacePanel">
            <div class="workspace-tabs">
                <button class="workspace-tab active" data-tab="workup">üîç Workup <span class="badge" id="workupCount">0</span></button>
                <button class="workspace-tab" data-tab="diagnoses">üéØ Dx <span class="badge" id="dxCount">0</span></button>
                <button class="workspace-tab" data-tab="testing">üß™ Tests <span class="badge" id="testCount">0</span></button>
                <button class="workspace-tab" data-tab="management">üíä Mgmt <span class="badge" id="mgmtCount">0</span></button>
                <button class="workspace-tab" data-tab="scoring">üìä Score</button>
            </div>
            <div class="workspace-content">
                <div class="tab-pane active" id="tab-workup">
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìã Case Phase</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><div class="phase-bar"><div class="phase-step active" onclick="setPhase(0)"></div><div class="phase-step" onclick="setPhase(1)"></div><div class="phase-step" onclick="setPhase(2)"></div><div class="phase-step" onclick="setPhase(3)"></div><div class="phase-step" onclick="setPhase(4)"></div></div><div class="phase-labels"><span class="phase-label active" onclick="setPhase(0)">HPI</span><span class="phase-label" onclick="setPhase(1)">Exam</span><span class="phase-label" onclick="setPhase(2)">Initial Dx</span><span class="phase-label" onclick="setPhase(3)">Results</span><span class="phase-label" onclick="setPhase(4)">Final Dx</span></div></div></div>
                    <div id="parsedSectionsPreview"></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üîë HPI / Key Findings</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="hpiNotes" placeholder="Key findings..."></textarea></div></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>ü©ª Physical Exam</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="examNotes" placeholder="Abnormal findings..."></textarea></div></div>
                    <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìù Notes</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><textarea class="notes-textarea" id="generalNotes" placeholder="Thoughts..."></textarea></div></div>
                </div>
                <div class="tab-pane" id="tab-diagnoses">
                    <div class="helper-text">Rank differentials. Drag to reorder.</div>
                    <div class="input-group"><input type="text" id="dxInput" placeholder="Enter a diagnosis..." onkeydown="if(event.key==='Enter')addDiagnosis()"><button class="btn btn-outline btn-sm" onclick="addDiagnosis()">+ Add</button></div>
                    <ul class="dx-list" id="dxList"></ul>
                </div>
                <div class="tab-pane" id="tab-testing">
                    <div class="helper-text">Order diagnostic tests.</div>
                    <div class="input-group" style="flex-wrap:wrap;"><input type="text" id="testInput" placeholder="e.g., CBC, CT chest..." onkeydown="if(event.key==='Enter')addTest()" style="flex:1;min-width:200px;"><select class="select-small" id="testCategory"><option value="lab">üß™ Lab</option><option value="imaging">ü©ª Imaging</option><option value="procedure">üî¨ Procedure</option><option value="other">üìã Other</option></select><button class="btn btn-outline btn-sm" onclick="addTest()">+ Add</button></div>
                    <div class="form-group" style="margin-bottom:14px;"><input type="text" id="testRationale" placeholder="Rationale (optional)" style="width:100%;padding:6px 12px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.83rem;"></div>
                    <ul class="item-list" id="testList"></ul>
                </div>
                <div class="tab-pane" id="tab-management">
                    <div class="helper-text">Treatments / interventions.</div>
                    <div class="input-group" style="flex-wrap:wrap;"><input type="text" id="mgmtInput" placeholder="e.g., IV NS 1L..." onkeydown="if(event.key==='Enter')addManagement()" style="flex:1;min-width:200px;"><select class="select-small" id="mgmtCategory"><option value="medication">üíä Medication</option><option value="intervention">üè• Intervention</option><option value="consult">üìû Consult</option><option value="other">üìã Other</option></select><button class="btn btn-outline btn-sm" onclick="addManagement()">+ Add</button></div>
                    <div class="form-group" style="margin-bottom:14px;"><input type="text" id="mgmtRationale" placeholder="Rationale (optional)" style="width:100%;padding:6px 12px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.83rem;"></div>
                    <ul class="item-list" id="mgmtList"></ul>
                </div>
                <div class="tab-pane" id="tab-scoring">
                    <div id="noScoreYet">
                        <div class="empty-state"><div class="empty-icon">üìä</div><p>Use ü§ñ Extract or enter the answer key manually.</p></div>
                        <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìù Answer Key</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">
                            <div class="form-group"><label>Clinical Diagnosis (initial)</label><input type="text" id="answerClinicalDx" placeholder="Working diagnosis"></div>
                            <div class="form-group"><label>Final Diagnosis ‚≠ê</label><input type="text" id="answerFinalDx" placeholder="Confirmed final diagnosis"></div>
                            <div class="form-group"><label>Differentials (comma-separated)</label><input type="text" id="answerDifferentials" placeholder="meningitis, SAH, migraine"></div>
                            <div class="form-group"><label>Labs & Tests (comma-separated)</label><input type="text" id="answerTests" placeholder="CBC, CRP, CT head"></div>
                            <div class="form-group"><label>Diagnostic Testing (comma-separated)</label><input type="text" id="answerDiagnosticTests" placeholder="MRI, echo, biopsy"></div>
                            <div class="form-group"><label>Treatments (comma-separated)</label><input type="text" id="answerTreatments" placeholder="IV antibiotics, surgery"></div>
                            <button class="btn btn-success" onclick="scoreCase()" style="width:100%;">üìä Score My Case</button>
                        </div></div>
                    </div>
                    <div id="scoreResults" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header"><h2>‚öô Settings</h2><button class="btn btn-ghost" onclick="closeSettings()">‚úï</button></div>
            <div class="modal-body">
                <div class="settings-group">
                    <h4>LLM Provider</h4>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="llmProvider" value="none"><div><div class="option-label">None (Manual)</div></div></label>
                        <label class="radio-option"><input type="radio" name="llmProvider" value="openrouter" checked><div><div class="option-label">OpenRouter ‚≠ê</div><div class="option-desc">Free models. Auto-finds working ones.</div></div></label>
                        <label class="radio-option"><input type="radio" name="llmProvider" value="gemini"><div><div class="option-label">Google Gemini (Free tier)</div></div></label>
                        <label class="radio-option"><input type="radio" name="llmProvider" value="openai"><div><div class="option-label">OpenAI (Paid)</div></div></label>
                        <label class="radio-option"><input type="radio" name="llmProvider" value="ollama"><div><div class="option-label">Ollama (Local, Free)</div></div></label>
                    </div>
                </div>
                <div class="settings-group" id="apiKeyGroup">
                    <h4>API Key</h4>
                    <div class="form-group">
                        <div class="key-input-wrapper"><input type="password" id="apiKeyInput" placeholder="Paste API key..."><button class="key-toggle" onclick="toggleKeyVis()">üëÅ</button></div>
                        <div style="font-size:0.75rem;color:var(--gray-400);margin-top:4px;">üîí Stored in localStorage only.</div>
                        <div id="apiKeyHelp" style="font-size:0.78rem;color:var(--primary);margin-top:4px;"></div>
                    </div>
                </div>
                <div class="settings-group" id="ollamaGroup" style="display:none;">
                    <h4>Ollama</h4>
                    <div class="form-group"><label>URL</label><input type="text" id="ollamaUrl" value="http://localhost:11434"></div>
                    <div class="form-group"><label>Model</label><input type="text" id="ollamaModel" value="llama3.2"></div>
                </div>
                <div class="settings-group" id="openrouterGroup">
                    <h4>OpenRouter Model</h4>
                    <div class="form-group">
                        <label>Model <button class="btn btn-sm btn-outline" onclick="scanModels()" id="scanBtn" style="margin-left:8px;font-size:0.7rem;">üîç Find Working Models</button></label>
                        <input type="text" id="openrouterModelInput" placeholder="e.g., meta-llama/llama-3.1-8b-instruct:free" style="width:100%;padding:8px;border:1.5px solid var(--gray-300);border-radius:var(--radius);font-size:0.85rem;margin-top:4px;">
                        <div style="font-size:0.75rem;color:var(--gray-400);margin-top:4px;">Enter any model ID from <a href="https://openrouter.ai/models?q=free" target="_blank" style="color:var(--primary)">openrouter.ai/models</a>. Click "Find Working Models" to auto-detect.</div>
                    </div>
                    <div id="modelScanResults" style="margin-top:8px;"></div>
                    <div class="info-box warning" style="margin-top:8px;">
                        <strong>‚ö†Ô∏è Free models require:</strong> <a href="https://openrouter.ai/settings/privacy" target="_blank">openrouter.ai/settings/privacy</a> ‚Üí Allow training data ‚Üí Save.
                    </div>
                </div>
                <div class="settings-group">
                    <h4>Diagnostics</h4>
                    <button class="btn btn-warning btn-sm" onclick="testConnection()" id="testBtn" style="width:100%;margin-bottom:8px;">üîå Test Connection</button>
                    <div class="debug-log" id="debugLog">Ready.\n</div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-ghost" onclick="closeSettings()">Cancel</button><button class="btn btn-success" onclick="saveSettings()">üíæ Save</button></div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
    const state = {
        pdfDoc:null, currentPage:1, zoom:1, pdfText:'', parsedSections:null,
        diagnoses:[], tests:[], management:[], currentPhase:0, answerKey:null, lastReasoning:null,
        llmProvider:'openrouter', apiKey:'', ollamaUrl:'http://localhost:11434', ollamaModel:'llama3.2',
        openrouterModel:'', nextId:1
    };

    function debugLog(m,t='info'){const el=document.getElementById('debugLog');if(!el)return;el.innerHTML+=`<span class="log-${t}">[${new Date().toLocaleTimeString()}] ${m}</span>\n`;el.scrollTop=el.scrollHeight;console.log(`[CaseDx]`,m);}

    document.addEventListener('DOMContentLoaded',()=>{
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        loadSettings();setupTabs();setupDragDrop();setupResize();updateLLMStatus();checkFirstRun();
        renderDiagnoses();renderTests();renderManagement();
    });
    function checkFirstRun(){if(!state.apiKey&&state.llmProvider!=='none'&&state.llmProvider!=='ollama')document.getElementById('setupBanner').style.display='flex';}
    function dismissBanner(){document.getElementById('setupBanner').style.display='none';}

    // ===== PDF =====
    document.getElementById('pdfInput').addEventListener('change',async e=>{if(e.target.files[0])await loadPDF(e.target.files[0]);});
    async function loadPDF(file){try{const b=await file.arrayBuffer();state.pdfDoc=await pdfjsLib.getDocument(new Uint8Array(b)).promise;document.getElementById('pdfToolbar').style.display='flex';document.getElementById('pdfPlaceholder').style.display='none';document.getElementById('pdfCanvasContainer').style.display='flex';document.getElementById('pageCount').textContent=state.pdfDoc.numPages;state.pdfText='';for(let i=1;i<=state.pdfDoc.numPages;i++){const p=await state.pdfDoc.getPage(i);const c=await p.getTextContent();state.pdfText+=c.items.map(x=>x.str).join(' ')+'\n\n';}state.currentPage=1;renderPage(1);state.parsedSections=parsePDFSections(state.pdfText);renderParsedPreview();showToast(`PDF loaded ‚Äî ${state.pdfDoc.numPages} pages`,'success');}catch(e){showToast('PDF error: '+e.message,'error');}}
    async function renderPage(n){if(!state.pdfDoc)return;const p=await state.pdfDoc.getPage(n);const v=p.getViewport({scale:state.zoom*1.5});const c=document.getElementById('pdfCanvasContainer');c.innerHTML='';const cv=document.createElement('canvas');cv.width=v.width;cv.height=v.height;await p.render({canvasContext:cv.getContext('2d'),viewport:v}).promise;c.appendChild(cv);document.getElementById('pageNum').textContent=n;}
    function prevPage(){if(state.currentPage>1)renderPage(--state.currentPage);}
    function nextPage(){if(state.pdfDoc&&state.currentPage<state.pdfDoc.numPages)renderPage(++state.currentPage);}
    function zoomIn(){state.zoom=Math.min(3,state.zoom+0.2);document.getElementById('zoomLevel').textContent=Math.round(state.zoom*100)+'%';renderPage(state.currentPage);}
    function zoomOut(){state.zoom=Math.max(0.3,state.zoom-0.2);document.getElementById('zoomLevel').textContent=Math.round(state.zoom*100)+'%';renderPage(state.currentPage);}
    function setupDragDrop(){const p=document.getElementById('pdfPanel');p.addEventListener('dragover',e=>{e.preventDefault();p.classList.add('drop-zone-active');});p.addEventListener('dragleave',()=>p.classList.remove('drop-zone-active'));p.addEventListener('drop',async e=>{e.preventDefault();p.classList.remove('drop-zone-active');const f=e.dataTransfer.files[0];if(f?.type==='application/pdf')await loadPDF(f);else showToast('Drop a PDF','error');});}

    // ===== PDF SECTION PARSER =====
    function parsePDFSections(text) {
        const sections = { clinicalDiagnosis:null, finalDiagnosis:null, differentialDiagnosis:null, differentialList:[], laboratoryData:null, diagnosticTesting:null, discussionOfManagement:null, fullText:text };
        const targets = [
            {key:'clinicalDiagnosis', re:[/Clinical\s+Diagnos[ie]s/i, /Clinical\s+Impression/i, /Working\s+Diagnos[ie]s/i]},
            {key:'finalDiagnosis', re:[/Final\s+Diagnos[ie]s/i, /Pathological\s+Diagnos[ie]s/i, /Anatomical\s+Diagnos[ie]s/i]},
            {key:'differentialDiagnosis', re:[/Differential\s+Diagnos[ie]s/i]},
            {key:'laboratoryData', re:[/Laboratory\s+Data/i, /Laboratory\s+Results/i, /Lab(?:oratory)?\s+Findings/i]},
            {key:'diagnosticTesting', re:[/Diagnostic\s+Testing/i, /Diagnostic\s+Studies/i, /Imaging\s+Studies/i]},
            {key:'discussionOfManagement', re:[/Discussion\s+of\s+Management/i, /Management\s+Discussion/i, /Treatment\s+and\s+Management/i]}
        ];
        // Generic section boundaries
        const boundaries = [/Presentation\s+of\s+Case/i, /Hospital\s+Course/i, /Discussion/i, /Clinical\s+Discussion/i, /Pathological\s+Discussion/i, /Radiologic/i, /Follow[\s-]?up/i, /References/i, /Physical\s+Examination/i, /History/i];

        const allH = [];
        for(const t of targets){for(const r of t.re){const m=text.match(r);if(m){allH.push({key:t.key,index:m.index,len:m[0].length,text:m[0]});break;}}}
        for(const r of boundaries){let m;const re=new RegExp(r.source,'gi');while((m=re.exec(text))!==null)allH.push({key:'_b',index:m.index,len:m[0].length});}
        // Add our target headers as boundaries too
        allH.sort((a,b)=>a.index-b.index);

        for(const h of allH){
            if(h.key==='_b')continue;
            const start=h.index+h.len;
            const next=allH.find(x=>x.index>h.index);
            const end=next?next.index:Math.min(start+3000,text.length);
            let content=text.substring(start,end).replace(/^[\s:;\-‚Äì‚Äî]+/,'').trim();

            if(h.key==='finalDiagnosis'||h.key==='clinicalDiagnosis'){
                const lines=content.split(/\n/).map(l=>l.trim()).filter(l=>l.length>2);
                const dxLines=[];
                for(const l of lines){if(l.length>200||/^(Discussion|Hospital|The patient|This case|Dr\.|In this)/i.test(l))break;dxLines.push(l);if(dxLines.length>=5)break;}
                sections[h.key]=dxLines.length?dxLines.join('\n'):content.substring(0,500);
            } else if(h.key==='differentialDiagnosis'){
                sections.differentialDiagnosis=content.substring(0,3000);
                // Extract individual diagnoses from sub-headers
                sections.differentialList = extractDifferentialList(content);
            } else {
                sections[h.key]=content.substring(0,2000);
            }
        }
        console.log('üìã Parsed sections:', Object.fromEntries(Object.entries(sections).filter(([k])=>k!=='fullText').map(([k,v])=>[k,v?((typeof v==='string'?v:'[array]')).substring(0,80)+'...':'NOT FOUND'])));
        return sections;
    }

    function extractDifferentialList(diffText) {
        // Differential diagnoses typically appear as sub-headers or bold items
        // Common patterns:
        // 1. Each diagnosis on its own line, often followed by a paragraph of discussion
        // 2. Numbered: "1. Meningitis", "2. Subarachnoid hemorrhage"
        // 3. Bold or capitalized names followed by description
        const diagnoses = [];
        const lines = diffText.split(/\n/);

        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed || trimmed.length < 3) continue;

            // Skip long paragraphs (these are discussions, not diagnosis names)
            if (trimmed.length > 120) continue;

            // Pattern: numbered list "1. Diagnosis name" or "1) Diagnosis"
            const numbered = trimmed.match(/^\d+[\.\)]\s*(.+)/);
            if (numbered) { diagnoses.push(numbered[1].trim()); continue; }

            // Pattern: bullet point "‚Ä¢ Diagnosis" or "- Diagnosis"
            const bulleted = trimmed.match(/^[‚Ä¢\-\*]\s*(.+)/);
            if (bulleted) { diagnoses.push(bulleted[1].trim()); continue; }

            // Pattern: Short line that looks like a title (< 80 chars, doesn't start with common words)
            if (trimmed.length <= 80 && !/^(The|This|It|In|A|An|However|Although|Because|Since|Dr\.|Figure|Table)/i.test(trimmed)) {
                // Check if it looks like a diagnosis name (capitalized, medical-sounding)
                if (/^[A-Z]/.test(trimmed) && !trimmed.endsWith(',') && !/\b(was|were|is|are|has|had|the patient|showed|revealed)\b/i.test(trimmed)) {
                    // Remove trailing periods
                    diagnoses.push(trimmed.replace(/\.$/, ''));
                }
            }
        }

        // Deduplicate and clean
        const unique = [...new Set(diagnoses.map(d => d.replace(/\s+/g, ' ').trim()))].filter(d => d.length > 2 && d.length < 100);
        console.log('üîç Extracted differentials:', unique);
        return unique;
    }

    function renderParsedPreview(){
        const c=document.getElementById('parsedSectionsPreview');
        if(!state.parsedSections){c.innerHTML='';return;}
        const s=state.parsedSections;
        const secs=[
            {key:'finalDiagnosis',label:'Final Diagnosis',icon:'üéØ'},
            {key:'clinicalDiagnosis',label:'Clinical Diagnosis',icon:'üè•'},
            {key:'differentialDiagnosis',label:'Differential Diagnosis',icon:'ü§î'},
            {key:'laboratoryData',label:'Laboratory Data',icon:'üß™'},
            {key:'diagnosticTesting',label:'Diagnostic Testing',icon:'ü©ª'},
            {key:'discussionOfManagement',label:'Management',icon:'üíä'}
        ];
        let html='<div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üìÑ Detected PDF Sections</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">';
        for(const sec of secs){
            const found=!!s[sec.key];
            let preview = found ? s[sec.key].substring(0,150).replace(/\n/g,' ')+'...' : 'Not found';
            html+=`<div class="parsed-section"><div class="parsed-section-header">${sec.icon} ${sec.label} <span class="${found?'found':'missing'}">${found?'‚úì':'‚úó'}</span></div><div class="parsed-section-body">${esc(preview)}</div>`;
            // Show differential list if available
            if(sec.key==='differentialDiagnosis' && s.differentialList && s.differentialList.length>0){
                html+=`<ul class="diff-dx-list" style="margin-top:6px;">`;
                for(const dx of s.differentialList) html+=`<li class="diff-dx-item">${esc(dx)}</li>`;
                html+=`</ul>`;
            }
            html+=`</div>`;
        }
        html+='</div></div>';
        c.innerHTML=html;
    }

    // ===== TABS =====
    function setupTabs(){document.querySelectorAll('.workspace-tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.workspace-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('tab-'+t.dataset.tab).classList.add('active');}));}
    function toggleSection(h){h.classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
    function setPhase(p){state.currentPhase=p;document.querySelectorAll('.phase-step').forEach((e,i)=>e.className='phase-step'+(i<p?' completed':'')+(i===p?' active':''));document.querySelectorAll('.phase-label').forEach((e,i)=>e.classList.toggle('active',i===p));}

    // ===== DX / TESTS / MGMT (same as before) =====
    function addDiagnosis(){const i=document.getElementById('dxInput'),t=i.value.trim();if(!t)return;state.diagnoses.push({id:state.nextId++,text:t,ruledOut:false});i.value='';i.focus();renderDiagnoses();}
    function removeDiagnosis(id){state.diagnoses=state.diagnoses.filter(d=>d.id!==id);renderDiagnoses();}
    function toggleRuleOut(id){const d=state.diagnoses.find(x=>x.id===id);if(d)d.ruledOut=!d.ruledOut;renderDiagnoses();}
    function moveDx(id,dir){const i=state.diagnoses.findIndex(d=>d.id===id),j=i+dir;if(i<0||j<0||j>=state.diagnoses.length)return;[state.diagnoses[i],state.diagnoses[j]]=[state.diagnoses[j],state.diagnoses[i]];renderDiagnoses();}
    function renderDiagnoses(){const l=document.getElementById('dxList');updateBadges();if(!state.diagnoses.length){l.innerHTML='';l.appendChild(mkEmpty('üéØ','No diagnoses yet.'));return;}l.innerHTML='';state.diagnoses.forEach((d,i)=>{const li=document.createElement('li');li.className='dx-item'+(d.ruledOut?' dx-ruled-out':'');li.draggable=true;li.dataset.id=d.id;li.addEventListener('dragstart',dxDS);li.addEventListener('dragover',dxDO);li.addEventListener('drop',dxDD);li.addEventListener('dragend',dxDE);li.innerHTML=`<span class="dx-drag-handle">‚†ø</span><span class="dx-rank ${i===0&&!d.ruledOut?'top':''}">${i+1}</span><span class="dx-text">${esc(d.text)}</span>${d.ruledOut?'<span class="answer-tag incorrect">Ruled Out</span>':''}<div class="dx-actions"><button class="btn btn-ghost btn-icon" onclick="moveDx(${d.id},-1)">‚ñ≤</button><button class="btn btn-ghost btn-icon" onclick="moveDx(${d.id},1)">‚ñº</button><button class="btn btn-ghost btn-icon" onclick="toggleRuleOut(${d.id})">${d.ruledOut?'‚ôª':'üö´'}</button><button class="btn btn-ghost btn-icon" onclick="removeDiagnosis(${d.id})">üóë</button></div>`;l.appendChild(li);});}
    let dragId=null;
    function dxDS(e){dragId=+e.currentTarget.dataset.id;e.currentTarget.classList.add('dragging');}
    function dxDO(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
    function dxDD(e){e.preventDefault();const t=+e.currentTarget.dataset.id;if(dragId==null||dragId===t)return;const fi=state.diagnoses.findIndex(d=>d.id===dragId),ti=state.diagnoses.findIndex(d=>d.id===t);const[m]=state.diagnoses.splice(fi,1);state.diagnoses.splice(ti,0,m);renderDiagnoses();}
    function dxDE(){dragId=null;document.querySelectorAll('.dx-item').forEach(e=>e.classList.remove('dragging','drag-over'));}
    function addTest(){const i=document.getElementById('testInput'),n=i.value.trim();if(!n)return;state.tests.push({id:state.nextId++,name:n,category:document.getElementById('testCategory').value,rationale:document.getElementById('testRationale').value.trim()});i.value='';document.getElementById('testRationale').value='';i.focus();renderTests();}
    function removeTest(id){state.tests=state.tests.filter(t=>t.id!==id);renderTests();}
    function renderTests(){const l=document.getElementById('testList');updateBadges();const ic={lab:'üß™',imaging:'ü©ª',procedure:'üî¨',other:'üìã'};if(!state.tests.length){l.innerHTML='';l.appendChild(mkEmpty('üß™','No tests.'));return;}l.innerHTML='';state.tests.forEach(t=>{const li=document.createElement('li');li.className='item-entry';li.innerHTML=`<span class="item-icon">${ic[t.category]||'üìã'}</span><div class="item-content"><div class="item-name">${esc(t.name)}</div>${t.rationale?`<div class="item-rationale">${esc(t.rationale)}</div>`:''}</div><span class="item-category cat-${t.category}">${t.category}</span><button class="btn btn-ghost btn-icon" onclick="removeTest(${t.id})">üóë</button>`;l.appendChild(li);});}
    function addManagement(){const i=document.getElementById('mgmtInput'),n=i.value.trim();if(!n)return;state.management.push({id:state.nextId++,name:n,category:document.getElementById('mgmtCategory').value,rationale:document.getElementById('mgmtRationale').value.trim()});i.value='';document.getElementById('mgmtRationale').value='';i.focus();renderManagement();}
    function removeManagement(id){state.management=state.management.filter(m=>m.id!==id);renderManagement();}
    function renderManagement(){const l=document.getElementById('mgmtList');updateBadges();const ic={medication:'üíä',intervention:'üè•',consult:'üìû',other:'üìã'};if(!state.management.length){l.innerHTML='';l.appendChild(mkEmpty('üíä','No management.'));return;}l.innerHTML='';state.management.forEach(m=>{const li=document.createElement('li');li.className='item-entry';li.innerHTML=`<span class="item-icon">${ic[m.category]||'üìã'}</span><div class="item-content"><div class="item-name">${esc(m.name)}</div>${m.rationale?`<div class="item-rationale">${esc(m.rationale)}</div>`:''}</div><span class="item-category cat-${m.category}">${m.category}</span><button class="btn btn-ghost btn-icon" onclick="removeManagement(${m.id})">üóë</button>`;l.appendChild(li);});}
    function updateBadges(){document.getElementById('dxCount').textContent=state.diagnoses.length;document.getElementById('testCount').textContent=state.tests.length;document.getElementById('mgmtCount').textContent=state.management.length;document.getElementById('workupCount').textContent=state.diagnoses.length+state.tests.length+state.management.length;}

    // ===== SCAN FOR WORKING OPENROUTER MODELS =====
    async function scanModels() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (!key) { showToast('Enter API key first','error'); return; }
        const container = document.getElementById('modelScanResults');
        const btn = document.getElementById('scanBtn');
        btn.disabled = true; btn.textContent = '‚è≥ Scanning...';

        // Candidates to test ‚Äî mix of common free model IDs
        const candidates = [
            'meta-llama/llama-3.1-8b-instruct:free',
            'meta-llama/llama-3.2-3b-instruct:free',
            'google/gemma-2-9b-it:free',
            'qwen/qwen-2.5-7b-instruct:free',
            'mistralai/mistral-7b-instruct:free',
            'microsoft/phi-3-mini-128k-instruct:free',
            'huggingfaceh4/zephyr-7b-beta:free',
            'openchat/openchat-7b:free',
            'meta-llama/llama-3.1-8b-instruct',
            'google/gemma-2-9b-it',
            'qwen/qwen-2.5-7b-instruct',
            'mistralai/mistral-7b-instruct',
            'nousresearch/hermes-3-llama-3.1-405b:free',
        ];

        container.innerHTML = '<div style="font-size:0.82rem;color:var(--gray-500);">Testing models...</div>';
        const results = [];

        for (const model of candidates) {
            try {
                const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}`, 'HTTP-Referer': window.location.href },
                    body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Say OK' }], max_tokens: 5 })
                });
                const d = await r.json();
                if (d.error) {
                    results.push({ model, status: 'unavailable', error: d.error.message });
                } else {
                    results.push({ model, status: 'available' });
                }
            } catch (e) {
                results.push({ model, status: 'unavailable', error: e.message });
            }
        }

        const working = results.filter(r => r.status === 'available');
        let html = `<div style="font-size:0.82rem;margin-bottom:6px;font-weight:600;">${working.length}/${candidates.length} models working:</div>`;
        for (const r of results) {
            const isFree = r.model.includes(':free');
            html += `<div style="padding:4px 8px;margin:2px 0;border-radius:4px;font-size:0.8rem;display:flex;align-items:center;gap:6px;background:${r.status==='available'?'var(--success-light)':'var(--gray-50)'};">
                <span style="color:${r.status==='available'?'var(--success)':'var(--danger)'};">${r.status==='available'?'‚úÖ':'‚ùå'}</span>
                <span style="flex:1;font-family:monospace;font-size:0.75rem;">${r.model}</span>
                ${r.status==='available' ? `<button class="btn btn-sm btn-success" onclick="document.getElementById('openrouterModelInput').value='${r.model}';showToast('Model selected!','success');" style="padding:2px 8px;font-size:0.7rem;">Use This</button>` : `<span style="font-size:0.7rem;color:var(--danger);">${(r.error||'').substring(0,40)}</span>`}
            </div>`;
        }

        if (working.length > 0 && !document.getElementById('openrouterModelInput').value) {
            document.getElementById('openrouterModelInput').value = working[0].model;
        }

        container.innerHTML = html;
        btn.disabled = false; btn.textContent = 'üîç Find Working Models';
    }

    // ===== LLM EXTRACTION =====
    async function extractWithLLM() {
        if(!state.pdfText.trim()){showToast('Load a PDF first.','error');return;}
        if(state.llmProvider==='none'){showToast('Configure LLM in Settings.','error');return;}
        if(!state.apiKey&&state.llmProvider!=='ollama'){showToast('API key needed.','error');openSettings();return;}
        if(state.llmProvider==='openrouter'&&!state.openrouterModel){showToast('Set a model in Settings first. Use "Find Working Models" to discover available ones.','error');openSettings();return;}

        const btn=document.getElementById('extractBtn'),orig=btn.innerHTML;
        btn.innerHTML='<span class="spinner"></span> Extracting...';btn.disabled=true;
        try{
            if(!state.parsedSections){state.parsedSections=parsePDFSections(state.pdfText);renderParsedPreview();}
            const prompt=buildStructuredPrompt(state.parsedSections);
            const result=await callLLM(prompt);
            const parsed=parseResponse(result.content);
            if(parsed){
                state.answerKey=parsed;state.lastReasoning=result.reasoning;
                document.getElementById('answerClinicalDx').value=parsed.clinicalDiagnosis||'';
                document.getElementById('answerFinalDx').value=parsed.finalDiagnosis||'';
                document.getElementById('answerDifferentials').value=(parsed.differentials||[]).join(', ');
                document.getElementById('answerTests').value=(parsed.labTests||[]).join(', ');
                document.getElementById('answerDiagnosticTests').value=(parsed.diagnosticTests||[]).join(', ');
                document.getElementById('answerTreatments').value=(parsed.treatments||[]).join(', ');
                showToast('‚úÖ Extracted!','success');
                document.querySelectorAll('.workspace-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
                document.querySelector('[data-tab="scoring"]').classList.add('active');
                document.getElementById('tab-scoring').classList.add('active');
            }else{showToast('Parse failed. Check console.','error');}
        }catch(err){
            console.error(err);
            let msg=err.message;
            if(msg.includes('Provider returned error')||msg.includes('502')||msg.includes('503'))msg=`Model error. Try "Find Working Models" in Settings to find one that works.`;
            if(msg.includes('No endpoints'))msg='Privacy policy blocks free models. Fix: openrouter.ai/settings/privacy';
            showToast(msg,'error');
        }finally{btn.innerHTML=orig;btn.disabled=false;}
    }

    function buildStructuredPrompt(s) {
        let p = `You are a medical education assistant. Extract information from this clinical case.

Return ONLY valid JSON. No markdown, no code fences.

{
  "clinicalDiagnosis": "from Clinical Diagnosis section",
  "finalDiagnosis": "from Final Diagnosis section ‚Äî THIS IS THE ANSWER",
  "differentials": ["each differential diagnosis considered"],
  "labTests": ["lab test: result", "lab test: result"],
  "diagnosticTests": ["imaging/procedure performed"],
  "treatments": ["treatment given"],
  "keyFindings": "brief summary"
}

`;
        if(s.finalDiagnosis) p+=`=== FINAL DIAGNOSIS ===\n${s.finalDiagnosis}\n\n`;
        if(s.clinicalDiagnosis) p+=`=== CLINICAL DIAGNOSIS ===\n${s.clinicalDiagnosis}\n\n`;
        if(s.differentialDiagnosis) p+=`=== DIFFERENTIAL DIAGNOSIS ===\n${s.differentialDiagnosis.substring(0,2000)}\n\n`;
        if(s.laboratoryData) p+=`=== LABORATORY DATA ===\n${s.laboratoryData.substring(0,1500)}\n\n`;
        if(s.diagnosticTesting) p+=`=== DIAGNOSTIC TESTING ===\n${s.diagnosticTesting.substring(0,1500)}\n\n`;
        if(s.discussionOfManagement) p+=`=== DISCUSSION OF MANAGEMENT ===\n${s.discussionOfManagement.substring(0,1500)}\n\n`;
        p+=`=== CASE CONTEXT ===\n${s.fullText.substring(0,2000)}\n`;
        return p;
    }

    async function callLLM(prompt){
        switch(state.llmProvider){
            case 'openrouter':return await fetchOpenRouter(prompt);
            case 'gemini':return{content:await fetchGemini(prompt),reasoning:null};
            case 'openai':return{content:await fetchOpenAI(prompt),reasoning:null};
            case 'ollama':return{content:await fetchOllama(prompt),reasoning:null};
            default:throw new Error('No LLM');
        }
    }
    async function fetchOpenAI(p){const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:p}],temperature:0.2,max_tokens:2000})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error?.message||`HTTP ${r.status}`);}return(await r.json()).choices[0].message.content;}
    async function fetchGemini(p){const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}],generationConfig:{temperature:0.2,maxOutputTokens:2000}})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error?.message||`HTTP ${r.status}`);}return(await r.json()).candidates[0].content.parts[0].text;}
    async function fetchOllama(p){const r=await fetch(`${state.ollamaUrl}/api/generate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:state.ollamaModel,prompt:p,stream:false,options:{temperature:0.2}})});if(!r.ok)throw new Error(`Ollama HTTP ${r.status}`);return(await r.json()).response;}

    async function fetchOpenRouter(prompt){
        const body={model:state.openrouterModel,messages:[{role:'user',content:prompt}],temperature:0.2,max_tokens:3000};
        debugLog(`Model: ${body.model}`);
        let r;
        try{r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`,'HTTP-Referer':window.location.href,'X-Title':'CaseDx'},body:JSON.stringify(body)});}
        catch(e){throw new Error(`Network: ${e.message}`);}
        const rt=await r.text();debugLog(`Status: ${r.status}`);
        if(!r.ok){let d=`HTTP ${r.status}`;try{const j=JSON.parse(rt);d=j.error?.message||d;debugLog(`Error: ${d}`,'error');}catch(e){debugLog(`Raw: ${rt.substring(0,200)}`,'error');}throw new Error(d);}
        const data=JSON.parse(rt);if(!data.choices?.length)throw new Error('Empty response');
        const msg=data.choices[0].message;debugLog(`Got ${(msg.content||'').length} chars`);
        let reasoning=null;if(msg.reasoning_details){reasoning=typeof msg.reasoning_details==='string'?msg.reasoning_details:Array.isArray(msg.reasoning_details)?msg.reasoning_details.map(r=>typeof r==='string'?r:(r.content||'')).join('\n'):null;}
        return{content:msg.content||'',reasoning};
    }

    function parseResponse(text){try{let s=text;const m1=s.match(/```(?:json)?\s*([\s\S]*?)```/);if(m1)s=m1[1];const m2=s.match(/\{[\s\S]*\}/);if(m2)s=m2[0];const p=JSON.parse(s);return{clinicalDiagnosis:p.clinicalDiagnosis||p.clinical_diagnosis||'',finalDiagnosis:p.finalDiagnosis||p.final_diagnosis||p.diagnosis||'',differentials:Array.isArray(p.differentials)?p.differentials:[],labTests:Array.isArray(p.labTests||p.lab_tests||p.tests)?(p.labTests||p.lab_tests||p.tests):[],diagnosticTests:Array.isArray(p.diagnosticTests||p.diagnostic_tests)?(p.diagnosticTests||p.diagnostic_tests):[],treatments:Array.isArray(p.treatments)?p.treatments:[],keyFindings:p.keyFindings||''};}catch(e){console.error('Parse:',e,text);return null;}}

    // ===== TEST / SCORE / SETTINGS =====
    async function testConnection(){
        const prov=document.querySelector('input[name="llmProvider"]:checked').value;
        const key=document.getElementById('apiKeyInput').value.trim();
        const model=document.getElementById('openrouterModelInput').value.trim();
        debugLog('--- TEST ---');debugLog(`Provider: ${prov}, Model: ${model}`);
        if(prov==='none')return;if(!key&&prov!=='ollama'){showToast('Enter key','error');return;}
        const old={k:state.apiKey,p:state.llmProvider,m:state.openrouterModel};
        state.apiKey=key;state.llmProvider=prov;state.openrouterModel=model;
        state.ollamaUrl=document.getElementById('ollamaUrl').value.trim();state.ollamaModel=document.getElementById('ollamaModel').value.trim();
        const btn=document.getElementById('testBtn');btn.innerHTML='<span class="spinner" style="border-color:rgba(255,255,255,0.3);border-top-color:white;"></span> Testing...';btn.disabled=true;
        try{await callLLM('Say OK');debugLog('SUCCESS!','info');showToast('‚úÖ Works!','success');}
        catch(e){debugLog(`FAIL: ${e.message}`,'error');showToast('‚ùå '+e.message.split('\n')[0],'error');state.apiKey=old.k;state.llmProvider=old.p;state.openrouterModel=old.m;}
        finally{btn.innerHTML='üîå Test Connection';btn.disabled=false;}
    }

    function scoreCase(){
        const finalDx=document.getElementById('answerFinalDx').value.trim();
        const clinicalDx=document.getElementById('answerClinicalDx').value.trim();
        if(!finalDx){showToast('Enter Final Diagnosis.','error');return;}
        const tests=document.getElementById('answerTests').value.split(',').map(s=>s.trim()).filter(Boolean);
        const diagTests=document.getElementById('answerDiagnosticTests').value.split(',').map(s=>s.trim()).filter(Boolean);
        const allTests=[...tests,...diagTests];
        const tx=document.getElementById('answerTreatments').value.split(',').map(s=>s.trim()).filter(Boolean);
        const diffs=document.getElementById('answerDifferentials').value.split(',').map(s=>s.trim()).filter(Boolean);
        state.answerKey={finalDiagnosis:finalDx,clinicalDiagnosis:clinicalDx,tests:allTests,treatments:tx,differentials:diffs};
        const dxS=calcDxScore(finalDx,diffs,clinicalDx);
        const testS=calcListScore(state.tests.map(t=>t.name),allTests);
        const mgmtS=calcListScore(state.management.map(m=>m.name),tx);
        const overall=Math.round((dxS.score+testS.score+mgmtS.score)/3);
        const c=document.getElementById('scoreResults');c.style.display='block';document.getElementById('noScoreYet').style.display='none';
        c.innerHTML=`
            <div class="dx-compare"><div class="dx-compare-card clinical"><div class="dx-type">üè• Clinical Diagnosis</div><div class="dx-value">${clinicalDx?esc(clinicalDx):'<span style="color:var(--gray-400)">N/A</span>'}</div></div><div class="dx-compare-card final"><div class="dx-type">üéØ Final Diagnosis</div><div class="dx-value">${esc(finalDx)}</div></div></div>
            <div class="score-card"><h3>Performance</h3><div class="score-grid"><div class="score-item"><div class="score-value ${sc(dxS.score)}">${dxS.score}%</div><div class="score-label">Diagnosis</div></div><div class="score-item"><div class="score-value ${sc(testS.score)}">${testS.score}%</div><div class="score-label">Testing</div></div><div class="score-item"><div class="score-value ${sc(mgmtS.score)}">${mgmtS.score}%</div><div class="score-label">Management</div></div></div><div style="text-align:center;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);"><div class="score-value ${sc(overall)}" style="font-size:2.5rem;">${overall}%</div><div class="score-label" style="font-size:0.85rem;">Overall</div></div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üéØ Diagnosis</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body"><p style="margin-bottom:4px"><strong>Final:</strong> ${esc(finalDx)}</p>${clinicalDx?`<p style="margin-bottom:8px;font-size:0.85rem;color:var(--gray-500)"><strong>Clinical:</strong> ${esc(clinicalDx)}</p>`:''}<p style="margin-bottom:12px;font-size:0.85rem;color:var(--gray-500)">${dxS.detail}</p>${state.diagnoses.length?`<table class="comparison-table"><tr><th>#</th><th>Your Differential</th><th>Status</th></tr>${state.diagnoses.map((d,i)=>`<tr><td>${i+1}</td><td class="${d.ruledOut?'match-no':''}">${esc(d.text)}${d.ruledOut?' (out)':''}</td><td>${dxTag(d.text,finalDx,clinicalDx,diffs)}</td></tr>`).join('')}</table>`:'<p style="color:var(--gray-400)">None entered.</p>'}</div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üß™ Testing</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">${cmpList('Yours',state.tests.map(t=>t.name),'Key',allTests)}</div></div>
            <div class="section-card"><div class="section-header" onclick="toggleSection(this)"><h3>üíä Management</h3><span class="collapse-icon">‚ñº</span></div><div class="section-body">${cmpList('Yours',state.management.map(m=>m.name),'Key',tx)}</div></div>
            <button class="btn btn-outline" onclick="document.getElementById('scoreResults').style.display='none';document.getElementById('noScoreYet').style.display='block';" style="width:100%;margin-top:8px;">‚Üê Edit Answer Key</button>`;
    }

    function calcDxScore(correct,diffs,clinical){
        if(!state.diagnoses.length)return{score:0,detail:'No diagnoses entered.'};
        const a=state.diagnoses.filter(x=>!x.ruledOut);if(!a.length)return{score:0,detail:'All ruled out.'};
        if(fuzzy(a[0].text,correct))return{score:100,detail:'Your #1 matches the Final Diagnosis! üéâ'};
        const mi=a.findIndex(x=>fuzzy(x.text,correct));if(mi>0)return{score:Math.max(20,85-mi*15),detail:`Final Dx was #${mi+1} on your list.`};
        // Partial credit for matching clinical dx
        if(clinical&&fuzzy(a[0].text,clinical))return{score:60,detail:'Your #1 matches the Clinical Dx, but not the Final Dx.'};
        const dm=a.filter(x=>diffs.some(df=>fuzzy(x.text,df))).length;
        if(dm)return{score:Math.min(40,dm*15),detail:`${dm} on differential but missed Final Dx.`};
        return{score:0,detail:'Final Diagnosis not on your differential.'};
    }
    function calcListScore(u,a){if(!a.length)return{score:100};if(!u.length)return{score:0};let m=0;a.forEach(x=>{if(u.some(y=>fuzzy(y,x)))m++;});return{score:Math.round(m/a.length*100)};}
    function fuzzy(a,b){a=a.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();b=b.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();if(a===b||a.includes(b)||b.includes(a))return true;const wa=a.split(/\s+/).filter(w=>w.length>2),wb=b.split(/\s+/).filter(w=>w.length>2);if(!wa.length||!wb.length)return false;return wa.filter(w=>wb.some(x=>x.includes(w)||w.includes(x))).length>=Math.min(2,Math.ceil(wb.length*0.6));}
    function dxTag(u,f,c,d){if(fuzzy(u,f))return'<span class="answer-tag correct">‚úì Final Dx</span>';if(c&&fuzzy(u,c))return'<span class="answer-tag partial">~ Clinical Dx</span>';if(d.some(x=>fuzzy(u,x)))return'<span class="answer-tag partial">~ Differential</span>';return'<span class="answer-tag incorrect">‚úó</span>';}
    function cmpList(ul,ui,al,ai){let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';h+=`<div><h4 style="font-size:0.85rem;margin-bottom:8px;color:var(--gray-600)">${ul}</h4>`;if(!ui.length)h+='<p style="color:var(--gray-400);font-size:0.85rem">None</p>';else ui.forEach(x=>{const m=ai.some(a=>fuzzy(x,a));h+=`<div style="padding:3px 0;font-size:0.85rem">${m?'<span class="match-yes">‚úì</span>':'<span class="match-no">‚óã</span>'} ${esc(x)}</div>`;});h+='</div>';h+=`<div><h4 style="font-size:0.85rem;margin-bottom:8px;color:var(--gray-600)">${al}</h4>`;if(!ai.length)h+='<p style="color:var(--gray-400);font-size:0.85rem">None</p>';else ai.forEach(x=>{const m=ui.some(u=>fuzzy(u,x));h+=`<div style="padding:3px 0;font-size:0.85rem">${m?'<span class="match-yes">‚úì</span>':'<span class="match-no">‚úó</span>'} ${esc(x)}</div>`;});h+='</div></div>';return h;}
    function sc(s){return s>=70?'good':s>=40?'okay':'poor';}

    // ===== SETTINGS =====
    function openSettings(){
        document.getElementById('settingsModal').classList.add('show');
        document.querySelectorAll('input[name="llmProvider"]').forEach(r=>r.checked=r.value===state.llmProvider);
        document.getElementById('apiKeyInput').value=state.apiKey;
        document.getElementById('ollamaUrl').value=state.ollamaUrl;
        document.getElementById('ollamaModel').value=state.ollamaModel;
        document.getElementById('openrouterModelInput').value=state.openrouterModel;
        updateSettingsUI();
        document.querySelectorAll('input[name="llmProvider"]').forEach(r=>r.addEventListener('change',updateSettingsUI));
    }
    function closeSettings(){document.getElementById('settingsModal').classList.remove('show');}
    function updateSettingsUI(){
        const p=document.querySelector('input[name="llmProvider"]:checked').value;
        document.getElementById('apiKeyGroup').style.display=['openai','gemini','openrouter'].includes(p)?'block':'none';
        document.getElementById('ollamaGroup').style.display=p==='ollama'?'block':'none';
        document.getElementById('openrouterGroup').style.display=p==='openrouter'?'block':'none';
        const links={openrouter:'‚Üí <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--primary)">Get free key</a>',gemini:'‚Üí <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary)">Get free key</a>',openai:'‚Üí <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--primary)">Get key</a>'};
        document.getElementById('apiKeyHelp').innerHTML=links[p]||'';
    }
    function saveSettings(){
        state.llmProvider=document.querySelector('input[name="llmProvider"]:checked').value;
        state.apiKey=document.getElementById('apiKeyInput').value.trim();
        state.ollamaUrl=document.getElementById('ollamaUrl').value.trim();
        state.ollamaModel=document.getElementById('ollamaModel').value.trim();
        state.openrouterModel=document.getElementById('openrouterModelInput').value.trim();
        localStorage.setItem('casedx_settings',JSON.stringify({llmProvider:state.llmProvider,apiKey:state.apiKey,ollamaUrl:state.ollamaUrl,ollamaModel:state.ollamaModel,openrouterModel:state.openrouterModel}));
        updateLLMStatus();dismissBanner();closeSettings();showToast('Saved!','success');
    }
    function loadSettings(){try{const s=JSON.parse(localStorage.getItem('casedx_settings'));if(s){state.llmProvider=s.llmProvider||'openrouter';state.apiKey=s.apiKey||'';state.ollamaUrl=s.ollamaUrl||'http://localhost:11434';state.ollamaModel=s.ollamaModel||'llama3.2';state.openrouterModel=s.openrouterModel||'';}}catch(e){}}
    function updateLLMStatus(){const dot=document.getElementById('llmDot'),name=document.getElementById('llmName');const names={none:'Manual',openai:'OpenAI',gemini:'Gemini',ollama:'Ollama',openrouter:'OpenRouter'};let dn=names[state.llmProvider]||'None';if(state.llmProvider==='openrouter'&&state.openrouterModel){const short=state.openrouterModel.split('/').pop().split(':')[0];dn+=` ¬∑ ${short}`;}name.textContent=dn;if(state.llmProvider==='none')dot.className='llm-dot';else if(state.llmProvider==='ollama')dot.className='llm-dot connected';else if(state.apiKey)dot.className='llm-dot connected';else dot.className='llm-dot needs-key';}
    function toggleKeyVis(){const i=document.getElementById('apiKeyInput');i.type=i.type==='password'?'text':'password';}
    function setupResize(){const h=document.getElementById('resizeHandle'),p=document.getElementById('workspacePanel');let r=false;h.addEventListener('mousedown',()=>{r=true;h.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';});document.addEventListener('mousemove',e=>{if(!r)return;const b=document.querySelector('.main-container').getBoundingClientRect();p.style.width=Math.max(380,Math.min(800,b.right-e.clientX))+'px';});document.addEventListener('mouseup',()=>{if(r){r=false;h.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';}});}
    function resetCase(){
        if(state.diagnoses.length+state.tests.length+state.management.length>0&&!confirm('Reset?'))return;
        Object.assign(state,{pdfDoc:null,currentPage:1,zoom:1,pdfText:'',parsedSections:null,diagnoses:[],tests:[],management:[],currentPhase:0,answerKey:null,lastReasoning:null,nextId:1});
        document.getElementById('pdfToolbar').style.display='none';document.getElementById('pdfPlaceholder').style.display='flex';document.getElementById('pdfCanvasContainer').style.display='none';document.getElementById('pdfCanvasContainer').innerHTML='';document.getElementById('zoomLevel').textContent='100%';document.getElementById('parsedSectionsPreview').innerHTML='';
        ['hpiNotes','examNotes','generalNotes','answerClinicalDx','answerFinalDx','answerDifferentials','answerTests','answerDiagnosticTests','answerTreatments'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('scoreResults').style.display='none';document.getElementById('noScoreYet').style.display='block';document.getElementById('pdfInput').value='';
        setPhase(0);renderDiagnoses();renderTests();renderManagement();
        document.querySelectorAll('.workspace-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));document.querySelector('.workspace-tab').classList.add('active');document.getElementById('tab-workup').classList.add('active');showToast('Reset!','info');
    }
    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function mkEmpty(i,m){const li=document.createElement('li');li.className='empty-state';li.innerHTML=`<div class="empty-icon">${i}</div><p>${m}</p>`;return li;}
    function showToast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast toast-${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(100%)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},6000);}
    </script>
</body>
</html>
